<center><a href="https://gitlab.com/petsc/petsc/-/blob/183cd29ee28cacc3ee84c625478d276606b77b2c/src/ksp/pc/impls/bjacobi/bjkokkos/bjkokkoskernels.kokkos.cxx">Actual source code: bjkokkoskernels.kokkos.cxx</a></center><br>

<html>
<head>
<title></title>
<meta name="generator" content="c2html 0.9.4">
<meta name="date" content="2024-03-29T14:13:02+00:00">
</head>

<body bgcolor="#FFFFFF">
<pre width="80">
<a name="line1">  1: </a>#include <A href="../../../../../../include/petsc/private/pcbjkokkosimpl.h.html">&lt;petsc/private/pcbjkokkosimpl.h&gt;</A>

<a name="line3">  3: </a><font color="#A020F0">#if defined(PETSC_HAVE_KOKKOS_KERNELS_BATCH)</font>
<a name="line4">  4: </a><font color="#A020F0">  #include &lt;fstream&gt;</font>

<a name="line6">  6: </a><font color="#A020F0">  #include </font><font color="#666666">"Kokkos_Timer.hpp"</font><font color="#A020F0"></font>
<a name="line7">  7: </a><font color="#A020F0">  #include </font><font color="#666666">"Kokkos_Random.hpp"</font><font color="#A020F0"></font>
<a name="line8">  8: </a><font color="#A020F0">  #include </font><font color="#666666">"Kokkos_UnorderedMap.hpp"</font><font color="#A020F0"></font>
<a name="line9">  9: </a><font color="#A020F0">  #include </font><font color="#666666">"Kokkos_Sort.hpp"</font><font color="#A020F0"></font>

<a name="line11"> 11: </a>  /// KokkosKernels headers
<a name="line12"> 12: </a><font color="#A020F0">  #include </font><font color="#666666">"KokkosBatched_Util.hpp"</font><font color="#A020F0"></font>
<a name="line13"> 13: </a><font color="#A020F0">  #include </font><font color="#666666">"KokkosBatched_Vector.hpp"</font><font color="#A020F0"></font>

<a name="line15"> 15: </a><font color="#A020F0">  #include &lt;Kokkos_ArithTraits.hpp&gt;</font>
<a name="line16"> 16: </a><font color="#A020F0">  #include &lt;KokkosBatched_Util.hpp&gt;</font>
<a name="line17"> 17: </a><font color="#A020F0">  #include &lt;KokkosBatched_Vector.hpp&gt;</font>
<a name="line18"> 18: </a><font color="#A020F0">  #include &lt;KokkosBatched_Copy_Decl.hpp&gt;</font>
<a name="line19"> 19: </a><font color="#A020F0">  #include &lt;KokkosBatched_Copy_Impl.hpp&gt;</font>
<a name="line20"> 20: </a><font color="#A020F0">  #include &lt;KokkosBatched_AddRadial_Decl.hpp&gt;</font>
<a name="line21"> 21: </a><font color="#A020F0">  #include &lt;KokkosBatched_AddRadial_Impl.hpp&gt;</font>
<a name="line22"> 22: </a><font color="#A020F0">  #include &lt;KokkosBatched_Gemm_Decl.hpp&gt;</font>
<a name="line23"> 23: </a><font color="#A020F0">  #include &lt;KokkosBatched_Gemm_Serial_Impl.hpp&gt;</font>
<a name="line24"> 24: </a><font color="#A020F0">  #include &lt;KokkosBatched_Gemm_Team_Impl.hpp&gt;</font>
<a name="line25"> 25: </a><font color="#A020F0">  #include &lt;KokkosBatched_Gemv_Decl.hpp&gt;</font>
<a name="line26"> 26: </a>  // #include &lt;KokkosBatched_Gemv_Serial_Impl.hpp&gt;
<a name="line27"> 27: </a><font color="#A020F0">  #include &lt;KokkosBatched_Gemv_Team_Impl.hpp&gt;</font>
<a name="line28"> 28: </a><font color="#A020F0">  #include &lt;KokkosBatched_Trsm_Decl.hpp&gt;</font>
<a name="line29"> 29: </a><font color="#A020F0">  #include &lt;KokkosBatched_Trsm_Serial_Impl.hpp&gt;</font>
<a name="line30"> 30: </a><font color="#A020F0">  #include &lt;KokkosBatched_Trsm_Team_Impl.hpp&gt;</font>
<a name="line31"> 31: </a><font color="#A020F0">  #include &lt;KokkosBatched_Trsv_Decl.hpp&gt;</font>
<a name="line32"> 32: </a><font color="#A020F0">  #include &lt;KokkosBatched_Trsv_Serial_Impl.hpp&gt;</font>
<a name="line33"> 33: </a><font color="#A020F0">  #include &lt;KokkosBatched_Trsv_Team_Impl.hpp&gt;</font>
<a name="line34"> 34: </a><font color="#A020F0">  #include &lt;KokkosBatched_LU_Decl.hpp&gt;</font>
<a name="line35"> 35: </a><font color="#A020F0">  #include &lt;KokkosBatched_LU_Serial_Impl.hpp&gt;</font>
<a name="line36"> 36: </a><font color="#A020F0">  #include &lt;KokkosBatched_LU_Team_Impl.hpp&gt;</font>
<a name="line37"> 37: </a><font color="#A020F0">  #include &lt;KokkosSparse_CrsMatrix.hpp&gt;</font>
<a name="line38"> 38: </a><font color="#A020F0">  #include </font><font color="#666666">"KokkosBatched_Spmv.hpp"</font><font color="#A020F0"></font>
<a name="line39"> 39: </a><font color="#A020F0">  #include </font><font color="#666666">"KokkosBatched_CrsMatrix.hpp"</font><font color="#A020F0"></font>
<a name="line40"> 40: </a><font color="#A020F0">  #include </font><font color="#666666">"KokkosBatched_Krylov_Handle.hpp"</font><font color="#A020F0"></font>

<a name="line42"> 42: </a><font color="#A020F0">  #include </font><font color="#666666">"KokkosBatched_GMRES.hpp"</font><font color="#A020F0"></font>
<a name="line43"> 43: </a><font color="#A020F0">  #include </font><font color="#666666">"KokkosBatched_JacobiPrec.hpp"</font><font color="#A020F0"></font>

<a name="line45"> 45: </a>template &lt;typename DeviceType, typename ValuesViewType, typename IntView, typename VectorViewType, typename KrylovHandleType&gt;
<a name="line46"> 46: </a><font color="#4169E1"><a name="Functor_TestBatchedTeamVectorGMRES"></a>struct Functor_TestBatchedTeamVectorGMRES </font>{
<a name="line47"> 47: </a>  const ValuesViewType _D;
<a name="line48"> 48: </a>  const ValuesViewType _diag;
<a name="line49"> 49: </a>  const IntView        _r;
<a name="line50"> 50: </a>  const IntView        _c;
<a name="line51"> 51: </a>  const VectorViewType _X;
<a name="line52"> 52: </a>  const VectorViewType _B;
<a name="line53"> 53: </a>  const int            _N_team, _team_size, _vector_length;
<a name="line54"> 54: </a>  const int            _N_iteration;
<a name="line55"> 55: </a>  const double         _tol;
<a name="line56"> 56: </a>  const int            _ortho_strategy;
<a name="line57"> 57: </a>  const int            _scratch_pad_level;
<a name="line58"> 58: </a>  KrylovHandleType     _handle;

<a name="line60"> 60: </a>  KOKKOS_INLINE_FUNCTION
<a name="line61"> 61: </a>  Functor_TestBatchedTeamVectorGMRES(const ValuesViewType &amp;D, const IntView &amp;r, const IntView &amp;c, const VectorViewType &amp;X, const VectorViewType &amp;B, const int N_team, const int team_size, const int vector_length, const int N_iteration, const double tol, const int ortho_strategy, const int scratch_pad_level, KrylovHandleType &amp;handle) :
<a name="line62"> 62: </a>    _D(D), _r(r), _c(c), _X(X), _B(B), _N_team(N_team), _team_size(team_size), _vector_length(vector_length), _N_iteration(N_iteration), _tol(tol), _ortho_strategy(ortho_strategy), _scratch_pad_level(scratch_pad_level), _handle(handle)
<a name="line63"> 63: </a>  {
<a name="line64"> 64: </a>  }

<a name="line66"> 66: </a>  KOKKOS_INLINE_FUNCTION
<a name="line67"> 67: </a>  Functor_TestBatchedTeamVectorGMRES(const ValuesViewType &amp;D, const ValuesViewType &amp;diag, const IntView &amp;r, const IntView &amp;c, const VectorViewType &amp;X, const VectorViewType &amp;B, const int N_team, const int team_size, const int vector_length, const int N_iteration, const double tol, int ortho_strategy, const int scratch_pad_level, KrylovHandleType &amp;handle) :
<a name="line68"> 68: </a>    _D(D), _diag(diag), _r(r), _c(c), _X(X), _B(B), _N_team(N_team), _team_size(team_size), _vector_length(vector_length), _N_iteration(N_iteration), _tol(tol), _ortho_strategy(ortho_strategy), _scratch_pad_level(scratch_pad_level), _handle(handle)
<a name="line69"> 69: </a>  {
<a name="line70"> 70: </a>  }

<a name="line72"> 72: </a>  template &lt;typename MemberType&gt;
<a name="line73"> 73: </a>  KOKKOS_INLINE_FUNCTION void operator()(const MemberType &amp;member) const
<a name="line74"> 74: </a>  {
<a name="line75"> 75: </a>    const int first_matrix = static_cast&lt;int&gt;(member.league_rank()) * _N_team;
<a name="line76"> 76: </a>    const int N            = _D.extent(0);
<a name="line77"> 77: </a>    const int last_matrix  = (static_cast&lt;int&gt;(member.league_rank() + 1) * _N_team &lt; N ? static_cast&lt;int&gt;(member.league_rank() + 1) * _N_team : N);
<a name="line78"> 78: </a>    const int graphID      = static_cast&lt;int&gt;(member.league_rank());
<a name="line79"> 79: </a>    using TeamVectorCopy1D = KokkosBatched::TeamVectorCopy&lt;MemberType, KokkosBatched::Trans::NoTranspose, 1&gt;;

<a name="line81"> 81: </a>    auto d                         = Kokkos::subview(_D, Kokkos::make_pair(first_matrix, last_matrix), Kokkos::ALL);
<a name="line82"> 82: </a>    auto x                         = Kokkos::subview(_X, Kokkos::make_pair(first_matrix, last_matrix), Kokkos::ALL);
<a name="line83"> 83: </a>    auto b                         = Kokkos::subview(_B, Kokkos::make_pair(first_matrix, last_matrix), Kokkos::ALL);
<a name="line84"> 84: </a>    using ScratchPadIntViewType    = Kokkos::View&lt;typename IntView::non_const_value_type *, typename IntView::array_layout, typename IntView::execution_space::scratch_memory_space&gt;;
<a name="line85"> 85: </a>    using ScratchPadValuesViewType = Kokkos::View&lt;typename ValuesViewType::non_const_value_type **, typename ValuesViewType::array_layout, typename ValuesViewType::execution_space::scratch_memory_space&gt;;

<a name="line87"> 87: </a>    using Operator = KokkosBatched::CrsMatrix&lt;ValuesViewType, ScratchPadIntViewType&gt;;
<a name="line88"> 88: </a>    ScratchPadIntViewType r(member.team_scratch(1), _r.extent(1));
<a name="line89"> 89: </a>    ScratchPadIntViewType c(member.team_scratch(1), _c.extent(1));

<a name="line91"> 91: </a><strong><font color="#FF0000">    TeamVectorCopy1D:</font></strong>:invoke(member, Kokkos::subview(_r, graphID, Kokkos::ALL), r);
<a name="line92"> 92: </a><strong><font color="#FF0000">    TeamVectorCopy1D:</font></strong>:invoke(member, Kokkos::subview(_c, graphID, Kokkos::ALL), c);
<a name="line93"> 93: </a>    Operator A(d, r, c);

<a name="line95"> 95: </a>    ScratchPadValuesViewType diag(member.team_scratch(1), last_matrix - first_matrix, _diag.extent(1));
<a name="line96"> 96: </a>    using PrecOperator = KokkosBatched::JacobiPrec&lt;ScratchPadValuesViewType&gt;;

<a name="line98"> 98: </a><strong><font color="#FF0000">    KokkosBatched:</font></strong>:TeamVectorCopy&lt;MemberType&gt;::invoke(member, Kokkos::subview(_diag, Kokkos::make_pair(first_matrix, last_matrix), Kokkos::ALL), diag);
<a name="line99"> 99: </a>    PrecOperator P(diag);
<a name="line100">100: </a>    P.setComputedInverse();

<a name="line102">102: </a><strong><font color="#FF0000">    KokkosBatched:</font></strong>:TeamVectorGMRES&lt;MemberType&gt;::template invoke&lt;Operator, VectorViewType, PrecOperator, KrylovHandleType&gt;(member, A, b, x, P, _handle);
<a name="line103">103: </a>  }
<a name="line104">104: </a>  inline double run(<a href="../../../../../../manualpages/PC/PC.html">PC</a> pc)
<a name="line105">105: </a>  {
<a name="line106">106: </a>    //<font color="#4169E1">typedef</font> typename ValuesViewType::value_type value_type;
<a name="line107">107: </a><strong><font color="#FF0000">    std:</font></strong>:string   name(<font color="#666666">"KokkosBatched::Test::TeamVectorGMRES"</font>);
<a name="line108">108: </a><strong><font color="#FF0000">    Kokkos:</font></strong>:Timer timer;
<a name="line109">109: </a><strong><font color="#FF0000">    Kokkos:</font></strong>:Profiling::pushRegion(name.c_str());

<a name="line111">111: </a><strong><font color="#FF0000">    Kokkos:</font></strong>:TeamPolicy&lt;DeviceType&gt; auto_policy(ceil(1. * _D.extent(0) / _N_team), Kokkos::AUTO(), Kokkos::AUTO());
<a name="line112">112: </a><strong><font color="#FF0000">    Kokkos:</font></strong>:TeamPolicy&lt;DeviceType&gt; tuned_policy(ceil(1. * _D.extent(0) / _N_team), _team_size, _vector_length);
<a name="line113">113: </a><strong><font color="#FF0000">    Kokkos:</font></strong>:TeamPolicy&lt;DeviceType&gt; policy;

<a name="line115">115: </a>    <font color="#4169E1">if</font> (_team_size &lt; 1) policy = auto_policy;
<a name="line116">116: </a>    <font color="#4169E1">else</font> policy = tuned_policy;

<a name="line118">118: </a>    _handle.set_max_iteration(_N_iteration);
<a name="line119">119: </a>    _handle.set_tolerance(_tol);
<a name="line120">120: </a>    _handle.set_ortho_strategy(_ortho_strategy);
<a name="line121">121: </a>    _handle.set_scratch_pad_level(_scratch_pad_level);
<a name="line122">122: </a>    _handle.set_compute_last_residual(true);

<a name="line124">124: </a>    int maximum_iteration = _handle.get_max_iteration();

<a name="line126">126: </a>    using ScalarType = typename ValuesViewType::non_const_value_type;
<a name="line127">127: </a>    using Layout     = typename ValuesViewType::array_layout;
<a name="line128">128: </a>    using EXSP       = typename ValuesViewType::execution_space;

<a name="line130">130: </a>    using ViewType2D    = Kokkos::View&lt;ScalarType **, Layout, EXSP&gt;;
<a name="line131">131: </a>    using IntViewType1D = Kokkos::View&lt;<a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> *, Layout, EXSP&gt;;

<a name="line133">133: </a>    size_t bytes_1D      = ViewType2D::shmem_size(_N_team, 1);
<a name="line134">134: </a>    size_t bytes_row_ptr = IntViewType1D::shmem_size(_r.extent(1));
<a name="line135">135: </a>    size_t bytes_col_idc = IntViewType1D::shmem_size(_c.extent(1));
<a name="line136">136: </a>    size_t bytes_2D_1    = ViewType2D::shmem_size(_N_team, _X.extent(1));
<a name="line137">137: </a>    size_t bytes_2D_2    = ViewType2D::shmem_size(_N_team, maximum_iteration + 1);

<a name="line139">139: </a>    size_t bytes_diag = bytes_2D_1;
<a name="line140">140: </a>    size_t bytes_tmp  = 2 * bytes_2D_1 + 2 * bytes_1D + bytes_2D_2;

<a name="line142">142: </a>    policy.set_scratch_size(0, Kokkos::PerTeam(bytes_tmp));
<a name="line143">143: </a>    policy.set_scratch_size(1, Kokkos::PerTeam(bytes_col_idc + bytes_row_ptr + bytes_diag));
<a name="line144">144: </a>    <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Profiling/PetscInfo.html">PetscInfo</a>(pc, <font color="#666666">"%d scratch memory(0) = %d + %d + %d bytes_diag=%d; %d scratch memory(1); %d maximum_iterations\n"</font>, (int)(bytes_tmp), 2 * (int)bytes_2D_1, 2 * (int)bytes_1D, (int)bytes_2D_2, (int)bytes_diag, (int)(bytes_row_ptr + bytes_col_idc + bytes_diag), (int)maximum_iteration));
<a name="line145">145: </a>    exec_space().fence();
<a name="line146">146: </a>    timer.reset();
<a name="line147">147: </a><strong><font color="#FF0000">    Kokkos:</font></strong>:parallel_for(name.c_str(), policy, *this);
<a name="line148">148: </a>    exec_space().fence();
<a name="line149">149: </a>    double sec = timer.seconds();

<a name="line151">151: </a>    <font color="#4169E1">return</font> sec;
<a name="line152">152: </a>  }
<a name="line153">153: </a>};

<a name="line155">155: </a><strong><font color="#4169E1"><a name="PCApply_BJKOKKOSKERNELS"></a>PETSC_INTERN <a href="../../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> PCApply_BJKOKKOSKERNELS(<a href="../../../../../../manualpages/PC/PC.html">PC</a> pc, const <a href="../../../../../../manualpages/Sys/PetscScalar.html">PetscScalar</a> *glb_bdata, <a href="../../../../../../manualpages/Sys/PetscScalar.html">PetscScalar</a> *glb_xdata, const <a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> *glb_Aai, const <a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> *glb_Aaj, const <a href="../../../../../../manualpages/Sys/PetscScalar.html">PetscScalar</a> *glb_Aaa, const <a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> team_size, <a href="../../../../../../manualpages/Mat/MatInfo.html">MatInfo</a> info, const <a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> batch_sz, <a href="../../../../../../manualpages/PC/PCFailedReason.html">PCFailedReason</a> *pcreason)</font></strong>
<a name="line156">156: </a>{
<a name="line157">157: </a>  PC_PCBJKOKKOS     *jac   = (PC_PCBJKOKKOS *)pc-&gt;data;
<a name="line158">158: </a>  <a href="../../../../../../manualpages/Mat/Mat.html">Mat</a>                A     = pc-&gt;pmat;
<a name="line159">159: </a>  const <a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a>     maxit = jac-&gt;ksp-&gt;max_it, nBlk = jac-&gt;nBlocks;
<a name="line160">160: </a>  const int          Nsolves      = nBlk;
<a name="line161">161: </a>  int                Nsolves_team = jac-&gt;nsolves_team, fill_idx = 0;
<a name="line162">162: </a>  int                Nloc           = jac-&gt;const_block_size;       // same grids
<a name="line163">163: </a>  const int          nnz            = (int)info.nz_used / Nsolves; // fix <font color="#4169E1">for</font> variable grid size
<a name="line164">164: </a>  <a href="../../../../../../manualpages/Sys/PetscReal.html">PetscReal</a>          rtol           = jac-&gt;ksp-&gt;rtol;
<a name="line165">165: </a>  const <a href="../../../../../../manualpages/Sys/PetscScalar.html">PetscScalar</a> *glb_idiag      = jac-&gt;d_idiag_k-&gt;data();
<a name="line166">166: </a>  const <a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a>    *d_bid_eqOffset = jac-&gt;d_bid_eqOffset_k-&gt;data();
<a name="line167">167: </a>  const <a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a>    *d_isicol = jac-&gt;d_isicol_k-&gt;data(), *d_isrow = jac-&gt;d_isrow_k-&gt;data();

<a name="line169">169: </a>  <a href="../../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line170">170: </a>  <font color="#4169E1">if</font> (Nsolves_team &gt; batch_sz) Nsolves_team = batch_sz; // silently fix this
<a name="line171">171: </a>  <a href="../../../../../../manualpages/Sys/PetscCheck.html">PetscCheck</a>(jac-&gt;const_block_size, <a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)pc), <a href="../../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a>, <font color="#666666">"Kokkos (GMRES) solver requires constant block size (but can be made to work with species ordering or N_team==1)"</font>);
<a name="line172">172: </a>  <a href="../../../../../../manualpages/Sys/PetscCheck.html">PetscCheck</a>(Nsolves % Nsolves_team == 0, <a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)pc), <a href="../../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a>, <font color="#666666">"Nsolves.mod(Nsolves_team) != 0: Nsolves = %d, Nsolves_team = %d"</font>, Nsolves, Nsolves_team);
<a name="line173">173: </a>  <a href="../../../../../../manualpages/Sys/PetscCheck.html">PetscCheck</a>(((int)info.nz_used) % Nsolves == 0, <a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)pc), <a href="../../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a>, <font color="#666666">"info.nz_used.mod(Nsolves) != 0: info.nz_used = %g, Nsolves = %d"</font>, info.nz_used, Nsolves);
<a name="line174">174: </a><font color="#A020F0">  #if defined(PETSC_HAVE_CUDA)</font>
<a name="line175">175: </a>  nvtxRangePushA(<font color="#666666">"gmres-kk"</font>);
<a name="line176">176: </a><font color="#A020F0">  #endif</font>
<a name="line177">177: </a><strong><font color="#FF0000">  Kokkos:</font></strong>:View&lt;<a href="../../../../../../manualpages/Sys/PetscScalar.html">PetscScalar</a> **, layout, exec_space, Kokkos::MemoryTraits&lt;Kokkos::Unmanaged&gt;&gt; inv_diag((<a href="../../../../../../manualpages/Sys/PetscScalar.html">PetscScalar</a> *)glb_idiag, Nsolves, Nloc); // in correct order
<a name="line178">178: </a>  <font color="#4169E1">if</font> (!jac-&gt;rowOffsets) {
<a name="line179">179: </a>    jac-&gt;rowOffsets   = new IntView(<font color="#666666">"rowOffsets"</font>, Nsolves / Nsolves_team, Nloc + 1); // same grids
<a name="line180">180: </a>    jac-&gt;colIndices   = new IntView(<font color="#666666">"colIndices"</font>, Nsolves / Nsolves_team, nnz);
<a name="line181">181: </a>    jac-&gt;batch_b      = new XYType(<font color="#666666">"batch rhs"</font>, Nsolves, Nloc);
<a name="line182">182: </a>    jac-&gt;batch_x      = new XYType(<font color="#666666">"batch sol"</font>, Nsolves, Nloc);
<a name="line183">183: </a>    jac-&gt;batch_values = new AMatrixValueView(<font color="#666666">"batch values"</font>, Nsolves, nnz);
<a name="line184">184: </a>    fill_idx          = 1;
<a name="line185">185: </a>    <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Profiling/PetscInfo.html">PetscInfo</a>(pc, <font color="#666666">"Setup indices Nloc=%d, nnz=%d\n"</font>, Nloc, nnz));
<a name="line186">186: </a>  }
<a name="line187">187: </a>  IntView          &amp;rowOffsets   = *jac-&gt;rowOffsets;
<a name="line188">188: </a>  IntView          &amp;colIndices   = *jac-&gt;colIndices;
<a name="line189">189: </a>  XYType           &amp;batch_b      = *jac-&gt;batch_b;
<a name="line190">190: </a>  XYType           &amp;batch_x      = *jac-&gt;batch_x;
<a name="line191">191: </a>  AMatrixValueView &amp;batch_values = *jac-&gt;batch_values;

<a name="line193">193: </a><strong><font color="#FF0000">  Kokkos:</font></strong>:deep_copy(batch_x, 0.);
<a name="line194">194: </a>  <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Profiling/PetscInfo.html">PetscInfo</a>(pc, <font color="#666666">"\tjac-&gt;n = %d, Nloc = %d, Nsolves = %d, nnz = %d, Nsolves_team = %d, league size = %d, maxit = %d\n"</font>, (int)jac-&gt;n, Nloc, Nsolves, nnz, Nsolves_team, Nsolves / Nsolves_team, (int)maxit));
<a name="line195">195: </a><strong><font color="#FF0000">  Kokkos:</font></strong>:parallel_for(
<a name="line196">196: </a>    <font color="#666666">"rowOffsets+map"</font>, Kokkos::TeamPolicy&lt;&gt;(Nsolves, team_size, PCBJKOKKOS_VEC_SIZE), KOKKOS_LAMBDA(const team_member team) {
<a name="line197">197: </a>      const int blkID = team.league_rank(), start = d_bid_eqOffset[blkID], end = d_bid_eqOffset[blkID + 1];
<a name="line198">198: </a>      <font color="#4169E1">if</font> (fill_idx) {
<a name="line199">199: </a>        <font color="#4169E1">if</font> (blkID % Nsolves_team == 0) {                                                        // first matrix on this member
<a name="line200">200: </a><strong><font color="#FF0000">          Kokkos:</font></strong>:parallel_for(Kokkos::TeamVectorRange(team, start, end), [=](const int rowb) { // Nloc
<a name="line201">201: </a>            int rowa                                           = d_isicol[rowb];
<a name="line202">202: </a>            int n                                              = glb_Aai[rowa + 1] - glb_Aai[rowa];
<a name="line203">203: </a>            rowOffsets(blkID / Nsolves_team, rowb + 1 - start) = n; // save sizes
<a name="line204">204: </a>          });
<a name="line205">205: </a>        }
<a name="line206">206: </a>      }
<a name="line207">207: </a>      // map b into field major space
<a name="line208">208: </a><strong><font color="#FF0000">      Kokkos:</font></strong>:parallel_for(Kokkos::TeamVectorRange(team, start, end), [=](int rowb) {
<a name="line209">209: </a>        int rowa                     = d_isicol[rowb];
<a name="line210">210: </a>        batch_b(blkID, rowb - start) = glb_bdata[rowa];
<a name="line211">211: </a>      });
<a name="line212">212: </a>    });
<a name="line213">213: </a><strong><font color="#FF0000">  Kokkos:</font></strong>:fence();
<a name="line214">214: </a>  <font color="#4169E1">if</font> (fill_idx) {
<a name="line215">215: </a><strong><font color="#FF0000">    Kokkos:</font></strong>:parallel_for(
<a name="line216">216: </a>      <font color="#666666">"prefix sum"</font>, Kokkos::TeamPolicy&lt;&gt;(Nsolves / Nsolves_team, 1, 1), KOKKOS_LAMBDA(const team_member team) {
<a name="line217">217: </a>        const int graphID      = team.league_rank();
<a name="line218">218: </a>        rowOffsets(graphID, 0) = 0;
<a name="line219">219: </a>        <font color="#4169E1">for</font> (int i = 0; i &lt; Nloc; ++i) rowOffsets(graphID, i + 1) += rowOffsets(graphID, i);
<a name="line220">220: </a>      });
<a name="line221">221: </a><strong><font color="#FF0000">    Kokkos:</font></strong>:fence();
<a name="line222">222: </a>  }
<a name="line223">223: </a><strong><font color="#FF0000">  Kokkos:</font></strong>:parallel_for(
<a name="line224">224: </a>    <font color="#666666">"copy matrix"</font>, Kokkos::TeamPolicy&lt;&gt;(Nsolves <font color="#B22222">/* /batch_sz */</font>, team_size, PCBJKOKKOS_VEC_SIZE), KOKKOS_LAMBDA(const team_member team) {
<a name="line225">225: </a>      const int blkID = team.league_rank(), start = d_bid_eqOffset[blkID], end = d_bid_eqOffset[blkID + 1], graphID = blkID / Nsolves_team;
<a name="line226">226: </a><strong><font color="#FF0000">      Kokkos:</font></strong>:parallel_for(Kokkos::TeamThreadRange(team, start, end), [=](const int rowb) {
<a name="line227">227: </a>        int                rowa = d_isicol[rowb];
<a name="line228">228: </a>        int                n    = glb_Aai[rowa + 1] - glb_Aai[rowa];
<a name="line229">229: </a>        const <a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a>    *aj   = glb_Aaj + glb_Aai[rowa]; // global index
<a name="line230">230: </a>        const <a href="../../../../../../manualpages/Sys/PetscScalar.html">PetscScalar</a> *aa   = glb_Aaa + glb_Aai[rowa];
<a name="line231">231: </a><strong><font color="#FF0000">        Kokkos:</font></strong>:parallel_for(Kokkos::ThreadVectorRange(team, n), [=](const int &amp;i) {
<a name="line232">232: </a>          <a href="../../../../../../manualpages/Sys/PetscScalar.html">PetscScalar</a> val = aa[i];
<a name="line233">233: </a>          <font color="#4169E1">if</font> (fill_idx &amp;&amp; blkID % Nsolves_team == 0) colIndices(graphID, rowOffsets(graphID, rowb - start) + i) = d_isrow[aj[i]] - blkID * Nloc; // local<font color="#666666">" global - block start</font>
<a name="line234">234: </a><font color="#666666">          batch_values(blkID, rowOffsets(graphID, rowb - start) + i) = val;</font>
<a name="line235">235: </a><font color="#666666">        });</font>
<a name="line236">236: </a><font color="#666666">      });</font>
<a name="line237">237: </a><font color="#666666">    });</font>
<a name="line238">238: </a><font color="#666666">  Kokkos::fence();</font>
<a name="line239">239: </a><font color="#666666">  // setup solver</font>
<a name="line240">240: </a><font color="#666666">  using ScalarType    = typename AMatrixValueView::non_const_value_type;</font>
<a name="line241">241: </a><font color="#666666">  using MagnitudeType = typename Kokkos::Details::ArithTraits&lt;ScalarType&gt;::mag_type;</font>
<a name="line242">242: </a><font color="#666666">  //using NormViewType              = Kokkos::View&lt;MagnitudeType *, layout, exec_space&gt;;</font>
<a name="line243">243: </a><font color="#666666">  using Norm2DViewType   = Kokkos::View&lt;MagnitudeType **, layout, exec_space&gt;;</font>
<a name="line244">244: </a><font color="#666666">  using Scalar3DViewType = Kokkos::View&lt;ScalarType ***, layout, exec_space&gt;;</font>
<a name="line245">245: </a><font color="#666666">  using IntViewType      = Kokkos::View&lt;int *, layout, exec_space&gt;;</font>
<a name="line246">246: </a><font color="#666666">  using KrylovHandleType = KokkosBatched::KrylovHandle&lt;Norm2DViewType, IntViewType, Scalar3DViewType&gt;;</font>
<a name="line247">247: </a><font color="#666666">  const int n_iterations = maxit;</font>
<a name="line248">248: </a><font color="#666666">  //const int        team_size      = -1;</font>
<a name="line249">249: </a><font color="#666666">  const int        vector_length  = -1;</font>
<a name="line250">250: </a><font color="#666666">  const double     tol            = rtol;</font>
<a name="line251">251: </a><font color="#666666">  const int        ortho_strategy = 0;</font>
<a name="line252">252: </a><font color="#666666">  KrylovHandleType handle(Nsolves, Nsolves_team, n_iterations, true);</font>
<a name="line253">253: </a><font color="#666666">  handle.Arnoldi_view = Scalar3DViewType("</font><font color="#666666">", Nsolves, n_iterations, Nloc + n_iterations + 3);</font>
<a name="line254">254: </a><font color="#666666">  // solve</font>
<a name="line255">255: </a><font color="#666666">  Functor_TestBatchedTeamVectorGMRES&lt;exec_space, AMatrixValueView, IntView, XYType, KrylovHandleType&gt;(batch_values, inv_diag, rowOffsets, colIndices, batch_x, batch_b, Nsolves_team, -1, vector_length, n_iterations, tol, ortho_strategy, 0, handle).run(pc);</font>
<a name="line256">256: </a><font color="#666666">  Kokkos::fence();</font>
<a name="line257">257: </a><font color="#666666">  // get data back</font>
<a name="line258">258: </a><font color="#666666">  Kokkos::parallel_for(</font>
<a name="line259">259: </a><font color="#666666">    "</font>map<font color="#666666">", Kokkos::TeamPolicy&lt;&gt;(Nsolves /* /batch_sz */, -1, PCBJKOKKOS_VEC_SIZE), KOKKOS_LAMBDA(const team_member team) {</font>
<a name="line260">260: </a><font color="#666666">      const int blkID = team.league_rank(), start = d_bid_eqOffset[blkID], end = d_bid_eqOffset[blkID + 1]; // 0</font>
<a name="line261">261: </a><font color="#666666">      // map x into Plex/PETSc</font>
<a name="line262">262: </a><font color="#666666">      Kokkos::parallel_for(Kokkos::TeamVectorRange(team, start, end), [=](int rowb) {</font>
<a name="line263">263: </a><font color="#666666">        int rowa        = d_isicol[rowb];</font>
<a name="line264">264: </a><font color="#666666">        glb_xdata[rowa] = batch_x(blkID, rowb - start);</font>
<a name="line265">265: </a><font color="#666666">      });</font>
<a name="line266">266: </a><font color="#666666">    });</font>
<a name="line267">267: </a><font color="#666666">  // output assume species major - clone from Kokkos solvers</font>
<a name="line268">268: </a><font color="#666666">  #if PCBJKOKKOS_VERBOSE_LEVEL &gt;= 3</font>
<a name="line269">269: </a><font color="#666666">    #if PCBJKOKKOS_VERBOSE_LEVEL &gt;= 4</font>
<a name="line270">270: </a><font color="#666666">  <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)A), "</font>Iterations\n<font color="#666666">"));</font>
<a name="line271">271: </a><font color="#666666">    #else</font>
<a name="line272">272: </a><font color="#666666">  <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)A), "</font>max iterations per species (gmres) :<font color="#666666">"));</font>
<a name="line273">273: </a><font color="#666666">    #endif</font>
<a name="line274">274: </a><font color="#666666">  for (<a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> dmIdx = 0, s = 0, head = 0; dmIdx &lt; jac-&gt;num_dms; dmIdx += batch_sz) {</font>
<a name="line275">275: </a><font color="#666666">    for (<a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> f = 0, idx = head; f &lt; jac-&gt;dm_Nf[dmIdx]; f++, s++, idx++) {</font>
<a name="line276">276: </a><font color="#666666">    #if PCBJKOKKOS_VERBOSE_LEVEL &gt;= 4</font>
<a name="line277">277: </a><font color="#666666">      <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)A), "</font>%2D:<font color="#666666">", s));</font>
<a name="line278">278: </a><font color="#666666">      for (int bid = 0; bid &lt; batch_sz; bid++) <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)A), "</font>%3D <font color="#666666">", handle.get_iteration_host(idx + bid * jac-&gt;dm_Nf[dmIdx])));</font>
<a name="line279">279: </a><font color="#666666">      <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)A), "</font>\n<font color="#666666">"));</font>
<a name="line280">280: </a><font color="#666666">    #else</font>
<a name="line281">281: </a><font color="#666666">      int count = 0, ii;</font>
<a name="line282">282: </a><font color="#666666">      for (int bid = 0; bid &lt; batch_sz; bid++) {</font>
<a name="line283">283: </a><font color="#666666">        if ((ii = handle.get_iteration_host(idx + bid * jac-&gt;dm_Nf[dmIdx])) &gt; count) count = ii;</font>
<a name="line284">284: </a><font color="#666666">      }</font>
<a name="line285">285: </a><font color="#666666">      <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)A), "</font>%3d<font color="#666666">", count));</font>
<a name="line286">286: </a><font color="#666666">    #endif</font>
<a name="line287">287: </a><font color="#666666">    }</font>
<a name="line288">288: </a><font color="#666666">    head += batch_sz * jac-&gt;dm_Nf[dmIdx];</font>
<a name="line289">289: </a><font color="#666666">  }</font>
<a name="line290">290: </a><font color="#666666">    #if PCBJKOKKOS_VERBOSE_LEVEL == 3</font>
<a name="line291">291: </a><font color="#666666">  <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)A), "</font>\n<font color="#666666">"));</font>
<a name="line292">292: </a><font color="#666666">    #endif</font>
<a name="line293">293: </a><font color="#666666">  #endif</font>
<a name="line294">294: </a><font color="#666666">  // return error code, get max it</font>
<a name="line295">295: </a><font color="#666666">  <a href="../../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> count = 0, mbid = 0;</font>
<a name="line296">296: </a><font color="#666666">  if (handle.is_converged_host()) {</font>
<a name="line297">297: </a><font color="#666666">    *pcreason = <a href="../../../../../../manualpages/PC/PCFailedReason.html">PC_NOERROR</a>;</font>
<a name="line298">298: </a><font color="#666666">    if (!jac-&gt;max_nits) {</font>
<a name="line299">299: </a><font color="#666666">      for (int blkID = 0; blkID &lt; nBlk; blkID++) {</font>
<a name="line300">300: </a><font color="#666666">        if (handle.get_iteration_host(blkID) &gt; jac-&gt;max_nits) {</font>
<a name="line301">301: </a><font color="#666666">          jac-&gt;max_nits = handle.get_iteration_host(blkID);</font>
<a name="line302">302: </a><font color="#666666">          mbid          = blkID;</font>
<a name="line303">303: </a><font color="#666666">        }</font>
<a name="line304">304: </a><font color="#666666">      }</font>
<a name="line305">305: </a><font color="#666666">    }</font>
<a name="line306">306: </a><font color="#666666">  } else {</font>
<a name="line307">307: </a><font color="#666666">    <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, "</font>There is at least one system that did not converge.<font color="#666666">"));</font>
<a name="line308">308: </a><font color="#666666">    *pcreason = <a href="../../../../../../manualpages/PC/PCFailedReason.html">PC_SUBPC_ERROR</a>;</font>
<a name="line309">309: </a><font color="#666666">  }</font>
<a name="line310">310: </a><font color="#666666">  // output - assume species major order</font>
<a name="line311">311: </a><font color="#666666">  for (int blkID = 0; blkID &lt; nBlk; blkID++) {</font>
<a name="line312">312: </a><font color="#666666">    if (jac-&gt;reason) { // -pc_bjkokkos_ksp_converged_reason</font>
<a name="line313">313: </a><font color="#666666">      if (jac-&gt;batch_target == blkID) {</font>
<a name="line314">314: </a><font color="#666666">        if (batch_sz != 1)</font>
<a name="line315">315: </a><font color="#666666">          <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)A), "</font>    Linear solve %s in %d iterations, batch %<font color="#666666">" PetscInt_FMT "</font>, species %<font color="#666666">" PetscInt_FMT "</font>\n<font color="#666666">", handle.is_converged_host(blkID) ? "</font>converged<font color="#666666">" : "</font>diverged<font color="#666666">", handle.get_iteration_host(blkID), blkID % batch_sz, blkID / batch_sz));</font>
<a name="line316">316: </a><font color="#666666">        else <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)A), "</font>    Linear solve %s in %d iterations, block %<font color="#666666">" PetscInt_FMT "</font>\n<font color="#666666">", handle.is_converged_host(blkID) ? "</font>converged<font color="#666666">" : "</font>diverged<font color="#666666">", handle.get_iteration_host(blkID), blkID));</font>
<a name="line317">317: </a><font color="#666666">      } else if (jac-&gt;batch_target == -1 &amp;&amp; handle.get_iteration_host(blkID) &gt;= count) {</font>
<a name="line318">318: </a><font color="#666666">        jac-&gt;max_nits = count = handle.get_iteration_host(blkID);</font>
<a name="line319">319: </a><font color="#666666">        mbid                  = blkID;</font>
<a name="line320">320: </a><font color="#666666">      }</font>
<a name="line321">321: </a><font color="#666666">      if (!handle.is_converged_host(blkID)) <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, "</font>ERROR species %d, batch %d did not converge with %d iterations\n<font color="#666666">", (int)(blkID / batch_sz), (int)blkID % batch_sz, handle.get_iteration_host(blkID)));</font>
<a name="line322">322: </a><font color="#666666">    }</font>
<a name="line323">323: </a><font color="#666666">  }</font>
<a name="line324">324: </a><font color="#666666">  if (jac-&gt;batch_target == -1 &amp;&amp; jac-&gt;reason) {</font>
<a name="line325">325: </a><font color="#666666">    if (batch_sz != 1)</font>
<a name="line326">326: </a><font color="#666666">      <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)A), "</font>    Linear solve %s in %d iteration, batch %<font color="#666666">" PetscInt_FMT "</font>, specie %<font color="#666666">" PetscInt_FMT "</font>\n<font color="#666666">", handle.is_converged_host(mbid) ? "</font>converged<font color="#666666">" : "</font>diverged<font color="#666666">", jac-&gt;max_nits, mbid % batch_sz, mbid / batch_sz));</font>
<a name="line327">327: </a><font color="#666666">    else <a href="../../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../../manualpages/Sys/PetscPrintf.html">PetscPrintf</a>(<a href="../../../../../../manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>)A), "</font>    Linear solve %s in %d iteration, block %<font color="#666666">" PetscInt_FMT "</font>\n<font color="#666666">", handle.is_converged_host(mbid) ? "</font>converged<font color="#666666">" : "</font>diverged<font color="#666666">", jac-&gt;max_nits, mbid));</font>
<a name="line328">328: </a><font color="#666666">  }</font>
<a name="line329">329: </a><font color="#666666">  #if defined(PETSC_HAVE_CUDA)</font>
<a name="line330">330: </a><font color="#666666">  nvtxRangePop();</font>
<a name="line331">331: </a><font color="#666666">  #endif</font>

<a name="line333">333: </a><font color="#666666">  return <a href="../../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>;</font>
<a name="line334">334: </a><font color="#666666">}</font>
<a name="line335">335: </a><font color="#666666">#endif</font>
</pre>
</body>

</html>
