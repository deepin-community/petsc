<center><a href="https://gitlab.com/petsc/petsc/-/blob/c7d19d7b3f2d9e6411c648820d1207320e4154c7/src/tao/bound/impls/bncg/bncg.c">Actual source code: bncg.c</a></center><br>

<html>
<head>
<title></title>
<meta name="generator" content="c2html 0.9.4">
<meta name="date" content="2023-03-30T15:49:56+00:00">
</head>

<body bgcolor="#FFFFFF">
<pre width="80">
<a name="line1">  1: </a>#include <A href="../../../../../include/petsctaolinesearch.h.html">&lt;petsctaolinesearch.h&gt;</A>
<a name="line2">  2: </a>#include <A href="bncg.h.html">&lt;../src/tao/bound/impls/bncg/bncg.h&gt;</A>
<a name="line3">  3: </a>#include <A href="../../../../../include/petscksp.h.html">&lt;petscksp.h&gt;</A>

<a name="line5">  5: </a><strong><font color="#228B22">#define CG_GradientDescent    0</font></strong>
<a name="line6">  6: </a><strong><font color="#228B22">#define CG_HestenesStiefel    1</font></strong>
<a name="line7">  7: </a><strong><font color="#228B22">#define CG_FletcherReeves     2</font></strong>
<a name="line8">  8: </a><strong><font color="#228B22">#define CG_PolakRibierePolyak 3</font></strong>
<a name="line9">  9: </a><strong><font color="#228B22">#define CG_PolakRibierePlus   4</font></strong>
<a name="line10"> 10: </a><strong><font color="#228B22">#define CG_DaiYuan            5</font></strong>
<a name="line11"> 11: </a><strong><font color="#228B22">#define CG_HagerZhang         6</font></strong>
<a name="line12"> 12: </a><strong><font color="#228B22">#define CG_DaiKou             7</font></strong>
<a name="line13"> 13: </a><strong><font color="#228B22">#define CG_KouDai             8</font></strong>
<a name="line14"> 14: </a><strong><font color="#228B22">#define CG_SSML_BFGS          9</font></strong>
<a name="line15"> 15: </a><strong><font color="#228B22">#define CG_SSML_DFP           10</font></strong>
<a name="line16"> 16: </a><strong><font color="#228B22">#define CG_SSML_BROYDEN       11</font></strong>
<a name="line17"> 17: </a><strong><font color="#228B22">#define CG_PCGradientDescent  12</font></strong>
<a name="line18"> 18: </a><strong><font color="#228B22">#define CGTypes               13</font></strong>

<a name="line20"> 20: </a>static const char *CG_Table[64] = {<font color="#666666">"gd"</font>, <font color="#666666">"hs"</font>, <font color="#666666">"fr"</font>, <font color="#666666">"pr"</font>, <font color="#666666">"prp"</font>, <font color="#666666">"dy"</font>, <font color="#666666">"hz"</font>, <font color="#666666">"dk"</font>, <font color="#666666">"kd"</font>, <font color="#666666">"ssml_bfgs"</font>, <font color="#666666">"ssml_dfp"</font>, <font color="#666666">"ssml_brdn"</font>, <font color="#666666">"pcgd"</font>};

<a name="line22"> 22: </a><strong><font color="#228B22">#define CG_AS_NONE      0</font></strong>
<a name="line23"> 23: </a><strong><font color="#228B22">#define CG_AS_BERTSEKAS 1</font></strong>
<a name="line24"> 24: </a><strong><font color="#228B22">#define CG_AS_SIZE      2</font></strong>

<a name="line26"> 26: </a>static const char *CG_AS_TYPE[64] = {<font color="#666666">"none"</font>, <font color="#666666">"bertsekas"</font>};

<a name="line28"> 28: </a><strong><font color="#4169E1"><a name="TaoBNCGEstimateActiveSet"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoBNCGEstimateActiveSet(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao, <a href="../../../../../docs/manualpages/Sys/PetscInt.html">PetscInt</a> asType)</font></strong>
<a name="line29"> 29: </a>{
<a name="line30"> 30: </a>  TAO_BNCG *cg = (TAO_BNCG *)tao-&gt;data;

<a name="line32"> 32: </a>  <a href="../../../../../docs/manualpages/IS/ISDestroy.html">ISDestroy</a>(&amp;cg-&gt;inactive_old);
<a name="line33"> 33: </a>  <font color="#4169E1">if</font> (cg-&gt;inactive_idx) {
<a name="line34"> 34: </a>    <a href="../../../../../docs/manualpages/IS/ISDuplicate.html">ISDuplicate</a>(cg-&gt;inactive_idx, &amp;cg-&gt;inactive_old);
<a name="line35"> 35: </a>    <a href="../../../../../docs/manualpages/IS/ISCopy.html">ISCopy</a>(cg-&gt;inactive_idx, cg-&gt;inactive_old);
<a name="line36"> 36: </a>  }
<a name="line37"> 37: </a>  <font color="#4169E1">switch</font> (asType) {
<a name="line38"> 38: </a>  <font color="#4169E1">case</font> CG_AS_NONE:
<a name="line39"> 39: </a>    <a href="../../../../../docs/manualpages/IS/ISDestroy.html">ISDestroy</a>(&amp;cg-&gt;inactive_idx);
<a name="line40"> 40: </a>    <a href="../../../../../docs/manualpages/Vec/VecWhichInactive.html">VecWhichInactive</a>(tao-&gt;XL, tao-&gt;solution, cg-&gt;unprojected_gradient, tao-&gt;XU, <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html">PETSC_TRUE</a>, &amp;cg-&gt;inactive_idx);
<a name="line41"> 41: </a>    <a href="../../../../../docs/manualpages/IS/ISDestroy.html">ISDestroy</a>(&amp;cg-&gt;active_idx);
<a name="line42"> 42: </a>    <a href="../../../../../docs/manualpages/Vec/ISComplementVec.html">ISComplementVec</a>(cg-&gt;inactive_idx, tao-&gt;solution, &amp;cg-&gt;active_idx);
<a name="line43"> 43: </a>    <font color="#4169E1">break</font>;

<a name="line45"> 45: </a>  <font color="#4169E1">case</font> CG_AS_BERTSEKAS:
<a name="line46"> 46: </a>    <font color="#B22222">/* Use gradient descent to estimate the active set */</font>
<a name="line47"> 47: </a>    <a href="../../../../../docs/manualpages/Vec/VecCopy.html">VecCopy</a>(cg-&gt;unprojected_gradient, cg-&gt;W);
<a name="line48"> 48: </a>    <a href="../../../../../docs/manualpages/Vec/VecScale.html">VecScale</a>(cg-&gt;W, -1.0);
<a name="line49"> 49: </a>    <a href="../../../../../docs/manualpages/Tao/TaoEstimateActiveBounds.html">TaoEstimateActiveBounds</a>(tao-&gt;solution, tao-&gt;XL, tao-&gt;XU, cg-&gt;unprojected_gradient, cg-&gt;W, cg-&gt;work, cg-&gt;as_step, &amp;cg-&gt;as_tol, &amp;cg-&gt;active_lower, &amp;cg-&gt;active_upper, &amp;cg-&gt;active_fixed, &amp;cg-&gt;active_idx, &amp;cg-&gt;inactive_idx);
<a name="line50"> 50: </a>    <font color="#4169E1">break</font>;
<a name="line51"> 51: </a><strong><font color="#FF0000">  default:</font></strong>
<a name="line52"> 52: </a>    <font color="#4169E1">break</font>;
<a name="line53"> 53: </a>  }
<a name="line54"> 54: </a>  <font color="#4169E1">return</font> 0;
<a name="line55"> 55: </a>}

<a name="line57"> 57: </a><strong><font color="#4169E1"><a name="TaoBNCGBoundStep"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoBNCGBoundStep(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao, <a href="../../../../../docs/manualpages/Sys/PetscInt.html">PetscInt</a> asType, <a href="../../../../../docs/manualpages/Vec/Vec.html">Vec</a> step)</font></strong>
<a name="line58"> 58: </a>{
<a name="line59"> 59: </a>  TAO_BNCG *cg = (TAO_BNCG *)tao-&gt;data;

<a name="line61"> 61: </a>  <font color="#4169E1">switch</font> (asType) {
<a name="line62"> 62: </a>  <font color="#4169E1">case</font> CG_AS_NONE:
<a name="line63"> 63: </a>    <a href="../../../../../docs/manualpages/Vec/VecISSet.html">VecISSet</a>(step, cg-&gt;active_idx, 0.0);
<a name="line64"> 64: </a>    <font color="#4169E1">break</font>;

<a name="line66"> 66: </a>  <font color="#4169E1">case</font> CG_AS_BERTSEKAS:
<a name="line67"> 67: </a>    <a href="../../../../../docs/manualpages/Tao/TaoBoundStep.html">TaoBoundStep</a>(tao-&gt;solution, tao-&gt;XL, tao-&gt;XU, cg-&gt;active_lower, cg-&gt;active_upper, cg-&gt;active_fixed, 1.0, step);
<a name="line68"> 68: </a>    <font color="#4169E1">break</font>;

<a name="line70"> 70: </a><strong><font color="#FF0000">  default:</font></strong>
<a name="line71"> 71: </a>    <font color="#4169E1">break</font>;
<a name="line72"> 72: </a>  }
<a name="line73"> 73: </a>  <font color="#4169E1">return</font> 0;
<a name="line74"> 74: </a>}

<a name="line76"> 76: </a><strong><font color="#4169E1"><a name="TaoSolve_BNCG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoSolve_BNCG(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao)</font></strong>
<a name="line77"> 77: </a>{
<a name="line78"> 78: </a>  TAO_BNCG *cg   = (TAO_BNCG *)tao-&gt;data;
<a name="line79"> 79: </a>  <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> step = 1.0, gnorm, gnorm2, resnorm;
<a name="line80"> 80: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html">PetscInt</a>  nDiff;

<a name="line82"> 82: </a>  <font color="#B22222">/*   Project the current point onto the feasible set */</font>
<a name="line83"> 83: </a>  <a href="../../../../../docs/manualpages/Tao/TaoComputeVariableBounds.html">TaoComputeVariableBounds</a>(tao);
<a name="line84"> 84: </a>  <a href="../../../../../docs/manualpages/TaoLineSearch/TaoLineSearchSetVariableBounds.html">TaoLineSearchSetVariableBounds</a>(tao-&gt;linesearch, tao-&gt;XL, tao-&gt;XU);

<a name="line86"> 86: </a>  <font color="#B22222">/* Project the initial point onto the feasible region */</font>
<a name="line87"> 87: </a>  <a href="../../../../../docs/manualpages/Tao/TaoBoundSolution.html">TaoBoundSolution</a>(tao-&gt;solution, tao-&gt;XL, tao-&gt;XU, 0.0, &amp;nDiff, tao-&gt;solution);

<a name="line89"> 89: </a>  <font color="#4169E1">if</font> (nDiff &gt; 0 || !tao-&gt;recycle) <a href="../../../../../docs/manualpages/Tao/TaoComputeObjectiveAndGradient.html">TaoComputeObjectiveAndGradient</a>(tao, tao-&gt;solution, &amp;cg-&gt;f, cg-&gt;unprojected_gradient);
<a name="line90"> 90: </a>  <a href="../../../../../docs/manualpages/Vec/VecNorm.html">VecNorm</a>(cg-&gt;unprojected_gradient, <a href="../../../../../docs/manualpages/Vec/NORM_2.html">NORM_2</a>, &amp;gnorm);

<a name="line93"> 93: </a>  <font color="#B22222">/* Estimate the active set and compute the projected gradient */</font>
<a name="line94"> 94: </a>  TaoBNCGEstimateActiveSet(tao, cg-&gt;as_type);

<a name="line96"> 96: </a>  <font color="#B22222">/* Project the gradient and calculate the norm */</font>
<a name="line97"> 97: </a>  <a href="../../../../../docs/manualpages/Vec/VecCopy.html">VecCopy</a>(cg-&gt;unprojected_gradient, tao-&gt;gradient);
<a name="line98"> 98: </a>  <a href="../../../../../docs/manualpages/Vec/VecISSet.html">VecISSet</a>(tao-&gt;gradient, cg-&gt;active_idx, 0.0);
<a name="line99"> 99: </a>  <a href="../../../../../docs/manualpages/Vec/VecNorm.html">VecNorm</a>(tao-&gt;gradient, <a href="../../../../../docs/manualpages/Vec/NORM_2.html">NORM_2</a>, &amp;gnorm);
<a name="line100">100: </a>  gnorm2 = gnorm * gnorm;

<a name="line102">102: </a>  <font color="#B22222">/* Initialize counters */</font>
<a name="line103">103: </a>  tao-&gt;niter   = 0;
<a name="line104">104: </a>  cg-&gt;ls_fails = cg-&gt;descent_error = 0;
<a name="line105">105: </a>  cg-&gt;resets                       = -1;
<a name="line106">106: </a>  cg-&gt;skipped_updates = cg-&gt;pure_gd_steps = 0;
<a name="line107">107: </a>  cg-&gt;iter_quad                           = 0;

<a name="line109">109: </a>  <font color="#B22222">/* Convergence test at the starting point. */</font>
<a name="line110">110: </a>  tao-&gt;reason = <a href="../../../../../docs/manualpages/Tao/TaoConvergedReason.html">TAO_CONTINUE_ITERATING</a>;

<a name="line112">112: </a>  <a href="../../../../../docs/manualpages/Tao/VecFischer.html">VecFischer</a>(tao-&gt;solution, cg-&gt;unprojected_gradient, tao-&gt;XL, tao-&gt;XU, cg-&gt;W);
<a name="line113">113: </a>  <a href="../../../../../docs/manualpages/Vec/VecNorm.html">VecNorm</a>(cg-&gt;W, <a href="../../../../../docs/manualpages/Vec/NORM_2.html">NORM_2</a>, &amp;resnorm);
<a name="line115">115: </a>  TaoLogConvergenceHistory(tao, cg-&gt;f, resnorm, 0.0, tao-&gt;ksp_its);
<a name="line116">116: </a>  <a href="../../../../../docs/manualpages/Tao/TaoMonitor.html">TaoMonitor</a>(tao, tao-&gt;niter, cg-&gt;f, resnorm, 0.0, step);
<a name="line117">117: </a>  <a href="../../../../../docs/manualpages/Sys/PetscUseTypeMethod.html">PetscUseTypeMethod</a>(tao, convergencetest, tao-&gt;cnvP);
<a name="line118">118: </a>  <font color="#4169E1">if</font> (tao-&gt;reason != <a href="../../../../../docs/manualpages/Tao/TaoConvergedReason.html">TAO_CONTINUE_ITERATING</a>) <font color="#4169E1">return</font> 0;
<a name="line119">119: </a>  <font color="#B22222">/* Calculate initial direction. */</font>
<a name="line120">120: </a>  <font color="#4169E1">if</font> (!tao-&gt;recycle) {
<a name="line121">121: </a>    <font color="#B22222">/* We are not recycling a solution/history from a past <a href="../../../../../docs/manualpages/Tao/TaoSolve.html">TaoSolve</a> */</font>
<a name="line122">122: </a>    TaoBNCGResetUpdate(tao, gnorm2);
<a name="line123">123: </a>  }
<a name="line124">124: </a>  <font color="#B22222">/* Initial gradient descent step. Scaling by 1.0 also does a decent job for some problems. */</font>
<a name="line125">125: </a>  <font color="#4169E1">while</font> (1) {
<a name="line126">126: </a>    <font color="#B22222">/* Call general purpose update function */</font>
<a name="line127">127: </a>    <font color="#4169E1">if</font> (tao-&gt;ops-&gt;update) {
<a name="line128">128: </a>      <a href="../../../../../docs/manualpages/Sys/PetscUseTypeMethod.html">PetscUseTypeMethod</a>(tao, update, tao-&gt;niter, tao-&gt;user_update);
<a name="line129">129: </a>      <a href="../../../../../docs/manualpages/Tao/TaoComputeObjectiveAndGradient.html">TaoComputeObjectiveAndGradient</a>(tao, tao-&gt;solution, &amp;cg-&gt;f, cg-&gt;unprojected_gradient);
<a name="line130">130: </a>    }
<a name="line131">131: </a>    TaoBNCGConductIteration(tao, gnorm);
<a name="line132">132: </a>    <font color="#4169E1">if</font> (tao-&gt;reason != <a href="../../../../../docs/manualpages/Tao/TaoConvergedReason.html">TAO_CONTINUE_ITERATING</a>) <font color="#4169E1">return</font> 0;
<a name="line133">133: </a>  }
<a name="line134">134: </a>}

<a name="line136">136: </a><strong><font color="#4169E1"><a name="TaoSetUp_BNCG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoSetUp_BNCG(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao)</font></strong>
<a name="line137">137: </a>{
<a name="line138">138: </a>  TAO_BNCG *cg = (TAO_BNCG *)tao-&gt;data;

<a name="line140">140: </a>  <font color="#4169E1">if</font> (!tao-&gt;gradient) <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;solution, &amp;tao-&gt;gradient);
<a name="line141">141: </a>  <font color="#4169E1">if</font> (!tao-&gt;stepdirection) <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;solution, &amp;tao-&gt;stepdirection);
<a name="line142">142: </a>  <font color="#4169E1">if</font> (!cg-&gt;W) <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;solution, &amp;cg-&gt;W);
<a name="line143">143: </a>  <font color="#4169E1">if</font> (!cg-&gt;work) <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;solution, &amp;cg-&gt;work);
<a name="line144">144: </a>  <font color="#4169E1">if</font> (!cg-&gt;sk) <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;solution, &amp;cg-&gt;sk);
<a name="line145">145: </a>  <font color="#4169E1">if</font> (!cg-&gt;yk) <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;gradient, &amp;cg-&gt;yk);
<a name="line146">146: </a>  <font color="#4169E1">if</font> (!cg-&gt;X_old) <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;solution, &amp;cg-&gt;X_old);
<a name="line147">147: </a>  <font color="#4169E1">if</font> (!cg-&gt;G_old) <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;gradient, &amp;cg-&gt;G_old);
<a name="line148">148: </a>  <font color="#4169E1">if</font> (cg-&gt;diag_scaling) {
<a name="line149">149: </a>    <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;solution, &amp;cg-&gt;d_work);
<a name="line150">150: </a>    <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;solution, &amp;cg-&gt;y_work);
<a name="line151">151: </a>    <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;solution, &amp;cg-&gt;g_work);
<a name="line152">152: </a>  }
<a name="line153">153: </a>  <font color="#4169E1">if</font> (!cg-&gt;unprojected_gradient) <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;gradient, &amp;cg-&gt;unprojected_gradient);
<a name="line154">154: </a>  <font color="#4169E1">if</font> (!cg-&gt;unprojected_gradient_old) <a href="../../../../../docs/manualpages/Vec/VecDuplicate.html">VecDuplicate</a>(tao-&gt;gradient, &amp;cg-&gt;unprojected_gradient_old);
<a name="line155">155: </a>  <a href="../../../../../docs/manualpages/KSP/MatLMVMAllocate.html">MatLMVMAllocate</a>(cg-&gt;B, cg-&gt;sk, cg-&gt;yk);
<a name="line156">156: </a>  <font color="#4169E1">if</font> (cg-&gt;pc) <a href="../../../../../docs/manualpages/KSP/MatLMVMSetJ0.html">MatLMVMSetJ0</a>(cg-&gt;B, cg-&gt;pc);
<a name="line157">157: </a>  <font color="#4169E1">return</font> 0;
<a name="line158">158: </a>}

<a name="line160">160: </a><strong><font color="#4169E1"><a name="TaoDestroy_BNCG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoDestroy_BNCG(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao)</font></strong>
<a name="line161">161: </a>{
<a name="line162">162: </a>  TAO_BNCG *cg = (TAO_BNCG *)tao-&gt;data;

<a name="line164">164: </a>  <font color="#4169E1">if</font> (tao-&gt;setupcalled) {
<a name="line165">165: </a>    <a href="../../../../../docs/manualpages/Vec/VecDestroy.html">VecDestroy</a>(&amp;cg-&gt;W);
<a name="line166">166: </a>    <a href="../../../../../docs/manualpages/Vec/VecDestroy.html">VecDestroy</a>(&amp;cg-&gt;work);
<a name="line167">167: </a>    <a href="../../../../../docs/manualpages/Vec/VecDestroy.html">VecDestroy</a>(&amp;cg-&gt;X_old);
<a name="line168">168: </a>    <a href="../../../../../docs/manualpages/Vec/VecDestroy.html">VecDestroy</a>(&amp;cg-&gt;G_old);
<a name="line169">169: </a>    <a href="../../../../../docs/manualpages/Vec/VecDestroy.html">VecDestroy</a>(&amp;cg-&gt;unprojected_gradient);
<a name="line170">170: </a>    <a href="../../../../../docs/manualpages/Vec/VecDestroy.html">VecDestroy</a>(&amp;cg-&gt;unprojected_gradient_old);
<a name="line171">171: </a>    <a href="../../../../../docs/manualpages/Vec/VecDestroy.html">VecDestroy</a>(&amp;cg-&gt;g_work);
<a name="line172">172: </a>    <a href="../../../../../docs/manualpages/Vec/VecDestroy.html">VecDestroy</a>(&amp;cg-&gt;d_work);
<a name="line173">173: </a>    <a href="../../../../../docs/manualpages/Vec/VecDestroy.html">VecDestroy</a>(&amp;cg-&gt;y_work);
<a name="line174">174: </a>    <a href="../../../../../docs/manualpages/Vec/VecDestroy.html">VecDestroy</a>(&amp;cg-&gt;sk);
<a name="line175">175: </a>    <a href="../../../../../docs/manualpages/Vec/VecDestroy.html">VecDestroy</a>(&amp;cg-&gt;yk);
<a name="line176">176: </a>  }
<a name="line177">177: </a>  <a href="../../../../../docs/manualpages/IS/ISDestroy.html">ISDestroy</a>(&amp;cg-&gt;active_lower);
<a name="line178">178: </a>  <a href="../../../../../docs/manualpages/IS/ISDestroy.html">ISDestroy</a>(&amp;cg-&gt;active_upper);
<a name="line179">179: </a>  <a href="../../../../../docs/manualpages/IS/ISDestroy.html">ISDestroy</a>(&amp;cg-&gt;active_fixed);
<a name="line180">180: </a>  <a href="../../../../../docs/manualpages/IS/ISDestroy.html">ISDestroy</a>(&amp;cg-&gt;active_idx);
<a name="line181">181: </a>  <a href="../../../../../docs/manualpages/IS/ISDestroy.html">ISDestroy</a>(&amp;cg-&gt;inactive_idx);
<a name="line182">182: </a>  <a href="../../../../../docs/manualpages/IS/ISDestroy.html">ISDestroy</a>(&amp;cg-&gt;inactive_old);
<a name="line183">183: </a>  <a href="../../../../../docs/manualpages/IS/ISDestroy.html">ISDestroy</a>(&amp;cg-&gt;new_inactives);
<a name="line184">184: </a>  <a href="../../../../../docs/manualpages/Mat/MatDestroy.html">MatDestroy</a>(&amp;cg-&gt;B);
<a name="line185">185: </a>  <font color="#4169E1">if</font> (cg-&gt;pc) <a href="../../../../../docs/manualpages/Mat/MatDestroy.html">MatDestroy</a>(&amp;cg-&gt;pc);
<a name="line186">186: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFree.html">PetscFree</a>(tao-&gt;data);
<a name="line187">187: </a>  <font color="#4169E1">return</font> 0;
<a name="line188">188: </a>}

<a name="line190">190: </a><strong><font color="#4169E1"><a name="TaoSetFromOptions_BNCG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoSetFromOptions_BNCG(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao, PetscOptionItems *PetscOptionsObject)</font></strong>
<a name="line191">191: </a>{
<a name="line192">192: </a>  TAO_BNCG *cg = (TAO_BNCG *)tao-&gt;data;

<a name="line194">194: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsHeadBegin.html">PetscOptionsHeadBegin</a>(PetscOptionsObject, <font color="#666666">"Nonlinear Conjugate Gradient method for unconstrained optimization"</font>);
<a name="line195">195: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsEList.html">PetscOptionsEList</a>(<font color="#666666">"-tao_bncg_type"</font>, <font color="#666666">"cg formula"</font>, <font color="#666666">""</font>, CG_Table, CGTypes, CG_Table[cg-&gt;cg_type], &amp;cg-&gt;cg_type, NULL);
<a name="line196">196: </a>  <font color="#4169E1">if</font> (cg-&gt;cg_type != CG_SSML_BFGS) cg-&gt;alpha = -1.0; <font color="#B22222">/* Setting defaults for non-BFGS methods. User can change it below. */</font>
<a name="line197">197: </a>  <font color="#4169E1">if</font> (CG_GradientDescent == cg-&gt;cg_type) {
<a name="line198">198: </a>    cg-&gt;cg_type = CG_PCGradientDescent;
<a name="line199">199: </a>    <font color="#B22222">/* Set scaling equal to none or, at best, scalar scaling. */</font>
<a name="line200">200: </a>    cg-&gt;unscaled_restart = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html">PETSC_TRUE</a>;
<a name="line201">201: </a>    cg-&gt;diag_scaling     = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;
<a name="line202">202: </a>  }
<a name="line203">203: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsEList.html">PetscOptionsEList</a>(<font color="#666666">"-tao_bncg_as_type"</font>, <font color="#666666">"active set estimation method"</font>, <font color="#666666">""</font>, CG_AS_TYPE, CG_AS_SIZE, CG_AS_TYPE[cg-&gt;cg_type], &amp;cg-&gt;cg_type, NULL);
<a name="line204">204: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_hz_eta"</font>, <font color="#666666">"(developer) cutoff tolerance for HZ"</font>, <font color="#666666">""</font>, cg-&gt;hz_eta, &amp;cg-&gt;hz_eta, NULL);
<a name="line205">205: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_eps"</font>, <font color="#666666">"(developer) cutoff value for restarts"</font>, <font color="#666666">""</font>, cg-&gt;epsilon, &amp;cg-&gt;epsilon, NULL);
<a name="line206">206: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_dk_eta"</font>, <font color="#666666">"(developer) cutoff tolerance for DK"</font>, <font color="#666666">""</font>, cg-&gt;dk_eta, &amp;cg-&gt;dk_eta, NULL);
<a name="line207">207: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_xi"</font>, <font color="#666666">"(developer) Parameter in the KD method"</font>, <font color="#666666">""</font>, cg-&gt;xi, &amp;cg-&gt;xi, NULL);
<a name="line208">208: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_theta"</font>, <font color="#666666">"(developer) update parameter for the Broyden method"</font>, <font color="#666666">""</font>, cg-&gt;theta, &amp;cg-&gt;theta, NULL);
<a name="line209">209: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_hz_theta"</font>, <font color="#666666">"(developer) parameter for the HZ (2006) method"</font>, <font color="#666666">""</font>, cg-&gt;hz_theta, &amp;cg-&gt;hz_theta, NULL);
<a name="line210">210: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_alpha"</font>, <font color="#666666">"(developer) parameter for the scalar scaling"</font>, <font color="#666666">""</font>, cg-&gt;alpha, &amp;cg-&gt;alpha, NULL);
<a name="line211">211: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_bfgs_scale"</font>, <font color="#666666">"(developer) update parameter for bfgs/brdn CG methods"</font>, <font color="#666666">""</font>, cg-&gt;bfgs_scale, &amp;cg-&gt;bfgs_scale, NULL);
<a name="line212">212: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_dfp_scale"</font>, <font color="#666666">"(developer) update parameter for bfgs/brdn CG methods"</font>, <font color="#666666">""</font>, cg-&gt;dfp_scale, &amp;cg-&gt;dfp_scale, NULL);
<a name="line213">213: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsBool.html">PetscOptionsBool</a>(<font color="#666666">"-tao_bncg_diag_scaling"</font>, <font color="#666666">"Enable diagonal Broyden-like preconditioning"</font>, <font color="#666666">""</font>, cg-&gt;diag_scaling, &amp;cg-&gt;diag_scaling, NULL);
<a name="line214">214: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsBool.html">PetscOptionsBool</a>(<font color="#666666">"-tao_bncg_dynamic_restart"</font>, <font color="#666666">"(developer) use dynamic restarts as in HZ, DK, KD"</font>, <font color="#666666">""</font>, cg-&gt;use_dynamic_restart, &amp;cg-&gt;use_dynamic_restart, NULL);
<a name="line215">215: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsBool.html">PetscOptionsBool</a>(<font color="#666666">"-tao_bncg_unscaled_restart"</font>, <font color="#666666">"(developer) use unscaled gradient restarts"</font>, <font color="#666666">""</font>, cg-&gt;unscaled_restart, &amp;cg-&gt;unscaled_restart, NULL);
<a name="line216">216: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_zeta"</font>, <font color="#666666">"(developer) Free parameter for the Kou-Dai method"</font>, <font color="#666666">""</font>, cg-&gt;zeta, &amp;cg-&gt;zeta, NULL);
<a name="line217">217: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsInt.html">PetscOptionsInt</a>(<font color="#666666">"-tao_bncg_min_quad"</font>, <font color="#666666">"(developer) Number of iterations with approximate quadratic behavior needed for restart"</font>, <font color="#666666">""</font>, cg-&gt;min_quad, &amp;cg-&gt;min_quad, NULL);
<a name="line218">218: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsInt.html">PetscOptionsInt</a>(<font color="#666666">"-tao_bncg_min_restart_num"</font>, <font color="#666666">"(developer) Number of iterations between restarts (times dimension)"</font>, <font color="#666666">""</font>, cg-&gt;min_restart_num, &amp;cg-&gt;min_restart_num, NULL);
<a name="line219">219: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsBool.html">PetscOptionsBool</a>(<font color="#666666">"-tao_bncg_spaced_restart"</font>, <font color="#666666">"(developer) Enable regular steepest descent restarting every fixed number of iterations"</font>, <font color="#666666">""</font>, cg-&gt;spaced_restart, &amp;cg-&gt;spaced_restart, NULL);
<a name="line220">220: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsBool.html">PetscOptionsBool</a>(<font color="#666666">"-tao_bncg_no_scaling"</font>, <font color="#666666">"Disable all scaling except in restarts"</font>, <font color="#666666">""</font>, cg-&gt;no_scaling, &amp;cg-&gt;no_scaling, NULL);
<a name="line221">221: </a>  <font color="#4169E1">if</font> (cg-&gt;no_scaling) {
<a name="line222">222: </a>    cg-&gt;diag_scaling = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;
<a name="line223">223: </a>    cg-&gt;alpha        = -1.0;
<a name="line224">224: </a>  }
<a name="line225">225: </a>  <font color="#4169E1">if</font> (cg-&gt;alpha == -1.0 &amp;&amp; cg-&gt;cg_type == CG_KouDai &amp;&amp; !cg-&gt;diag_scaling) { <font color="#B22222">/* Some more default options that appear to be good. */</font>
<a name="line226">226: </a>    cg-&gt;neg_xi = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html">PETSC_TRUE</a>;
<a name="line227">227: </a>  }
<a name="line228">228: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsBool.html">PetscOptionsBool</a>(<font color="#666666">"-tao_bncg_neg_xi"</font>, <font color="#666666">"(developer) Use negative xi when it might be a smaller descent direction than necessary"</font>, <font color="#666666">""</font>, cg-&gt;neg_xi, &amp;cg-&gt;neg_xi, NULL);
<a name="line229">229: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_as_tol"</font>, <font color="#666666">"(developer) initial tolerance used when estimating actively bounded variables"</font>, <font color="#666666">""</font>, cg-&gt;as_tol, &amp;cg-&gt;as_tol, NULL);
<a name="line230">230: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_as_step"</font>, <font color="#666666">"(developer) step length used when estimating actively bounded variables"</font>, <font color="#666666">""</font>, cg-&gt;as_step, &amp;cg-&gt;as_step, NULL);
<a name="line231">231: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_delta_min"</font>, <font color="#666666">"(developer) minimum scaling factor used for scaled gradient restarts"</font>, <font color="#666666">""</font>, cg-&gt;delta_min, &amp;cg-&gt;delta_min, NULL);
<a name="line232">232: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html">PetscOptionsReal</a>(<font color="#666666">"-tao_bncg_delta_max"</font>, <font color="#666666">"(developer) maximum scaling factor used for scaled gradient restarts"</font>, <font color="#666666">""</font>, cg-&gt;delta_max, &amp;cg-&gt;delta_max, NULL);

<a name="line234">234: </a>  PetscOptionsHeadEnd();
<a name="line235">235: </a>  <a href="../../../../../docs/manualpages/Mat/MatSetOptionsPrefix.html">MatSetOptionsPrefix</a>(cg-&gt;B, ((<a href="../../../../../docs/manualpages/Sys/PetscObject.html">PetscObject</a>)tao)-&gt;prefix);
<a name="line236">236: </a>  <a href="../../../../../docs/manualpages/Mat/MatAppendOptionsPrefix.html">MatAppendOptionsPrefix</a>(cg-&gt;B, <font color="#666666">"tao_bncg_"</font>);
<a name="line237">237: </a>  <a href="../../../../../docs/manualpages/Mat/MatSetFromOptions.html">MatSetFromOptions</a>(cg-&gt;B);
<a name="line238">238: </a>  <font color="#4169E1">return</font> 0;
<a name="line239">239: </a>}

<a name="line241">241: </a><strong><font color="#4169E1"><a name="TaoView_BNCG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoView_BNCG(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao, <a href="../../../../../docs/manualpages/Viewer/PetscViewer.html">PetscViewer</a> viewer)</font></strong>
<a name="line242">242: </a>{
<a name="line243">243: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html">PetscBool</a> isascii;
<a name="line244">244: </a>  TAO_BNCG *cg = (TAO_BNCG *)tao-&gt;data;

<a name="line246">246: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectTypeCompare.html">PetscObjectTypeCompare</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html">PetscObject</a>)viewer, <a href="../../../../../docs/manualpages/Viewer/PETSCVIEWERASCII.html">PETSCVIEWERASCII</a>, &amp;isascii);
<a name="line247">247: </a>  <font color="#4169E1">if</font> (isascii) {
<a name="line248">248: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPushTab.html">PetscViewerASCIIPushTab</a>(viewer);
<a name="line249">249: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"CG Type: %s\n"</font>, CG_Table[cg-&gt;cg_type]);
<a name="line250">250: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"Skipped Stepdirection Updates: %"</font> PetscInt_FMT <font color="#666666">"\n"</font>, cg-&gt;skipped_updates);
<a name="line251">251: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"Scaled gradient steps: %"</font> PetscInt_FMT <font color="#666666">"\n"</font>, cg-&gt;resets);
<a name="line252">252: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"Pure gradient steps: %"</font> PetscInt_FMT <font color="#666666">"\n"</font>, cg-&gt;pure_gd_steps);
<a name="line253">253: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"Not a descent direction: %"</font> PetscInt_FMT <font color="#666666">"\n"</font>, cg-&gt;descent_error);
<a name="line254">254: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"Line search fails: %"</font> PetscInt_FMT <font color="#666666">"\n"</font>, cg-&gt;ls_fails);
<a name="line255">255: </a>    <font color="#4169E1">if</font> (cg-&gt;diag_scaling) {
<a name="line256">256: </a>      <a href="../../../../../docs/manualpages/Sys/PetscObjectTypeCompare.html">PetscObjectTypeCompare</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html">PetscObject</a>)viewer, <a href="../../../../../docs/manualpages/Viewer/PETSCVIEWERASCII.html">PETSCVIEWERASCII</a>, &amp;isascii);
<a name="line257">257: </a>      <font color="#4169E1">if</font> (isascii) {
<a name="line258">258: </a>        <a href="../../../../../docs/manualpages/Viewer/PetscViewerPushFormat.html">PetscViewerPushFormat</a>(viewer, <a href="../../../../../docs/manualpages/Viewer/PetscViewerFormat.html">PETSC_VIEWER_ASCII_INFO</a>);
<a name="line259">259: </a>        <a href="../../../../../docs/manualpages/Mat/MatView.html">MatView</a>(cg-&gt;B, viewer);
<a name="line260">260: </a>        <a href="../../../../../docs/manualpages/Viewer/PetscViewerPopFormat.html">PetscViewerPopFormat</a>(viewer);
<a name="line261">261: </a>      }
<a name="line262">262: </a>    }
<a name="line263">263: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPopTab.html">PetscViewerASCIIPopTab</a>(viewer);
<a name="line264">264: </a>  }
<a name="line265">265: </a>  <font color="#4169E1">return</font> 0;
<a name="line266">266: </a>}

<a name="line268">268: </a><strong><font color="#4169E1"><a name="TaoBNCGComputeScalarScaling"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoBNCGComputeScalarScaling(<a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> yty, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> yts, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> sts, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> *scale, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> alpha)</font></strong>
<a name="line269">269: </a>{
<a name="line270">270: </a>  <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> a, b, c, sig1, sig2;

<a name="line272">272: </a>  *scale = 0.0;
<a name="line273">273: </a>  <font color="#4169E1">if</font> (1.0 == alpha) *scale = yts / yty;
<a name="line274">274: </a>  <font color="#4169E1">else</font> <font color="#4169E1">if</font> (0.0 == alpha) *scale = sts / yts;
<a name="line275">275: </a>  <font color="#4169E1">else</font> <font color="#4169E1">if</font> (-1.0 == alpha) *scale = 1.0;
<a name="line276">276: </a>  <font color="#4169E1">else</font> {
<a name="line277">277: </a>    a = yty;
<a name="line278">278: </a>    b = yts;
<a name="line279">279: </a>    c = sts;
<a name="line280">280: </a>    a *= alpha;
<a name="line281">281: </a>    b *= -(2.0 * alpha - 1.0);
<a name="line282">282: </a>    c *= alpha - 1.0;
<a name="line283">283: </a>    sig1 = (-b + PetscSqrtReal(b * b - 4.0 * a * c)) / (2.0 * a);
<a name="line284">284: </a>    sig2 = (-b - PetscSqrtReal(b * b - 4.0 * a * c)) / (2.0 * a);
<a name="line285">285: </a>    <font color="#B22222">/* accept the positive root as the scalar */</font>
<a name="line286">286: </a>    <font color="#4169E1">if</font> (sig1 &gt; 0.0) *scale = sig1;
<a name="line287">287: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (sig2 &gt; 0.0) *scale = sig2;
<a name="line288">288: </a>    <font color="#4169E1">else</font> <a href="../../../../../docs/manualpages/Sys/SETERRQ.html">SETERRQ</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, PETSC_ERR_CONV_FAILED, <font color="#666666">"Cannot find positive scalar"</font>);
<a name="line289">289: </a>  }
<a name="line290">290: </a>  <font color="#4169E1">return</font> 0;
<a name="line291">291: </a>}

<a name="line293">293: </a><font color="#B22222">/*MC</font>
<a name="line294">294: </a><font color="#B22222">  <a href="../../../../../docs/manualpages/Tao/TAOBNCG.html">TAOBNCG</a> - Bound-constrained Nonlinear Conjugate Gradient method.</font>

<a name="line296">296: </a><font color="#B22222">  Options Database Keys:</font>
<a name="line297">297: </a><font color="#B22222">+ -tao_bncg_recycle - enable recycling the latest calculated gradient vector in subsequent <a href="../../../../../docs/manualpages/Tao/TaoSolve.html">TaoSolve</a>() calls (currently disabled)</font>
<a name="line298">298: </a><font color="#B22222">. -tao_bncg_eta &lt;r&gt; - restart tolerance</font>
<a name="line299">299: </a><font color="#B22222">. -tao_bncg_type &lt;taocg_type&gt; - cg formula</font>
<a name="line300">300: </a><font color="#B22222">. -tao_bncg_as_type &lt;none,bertsekas&gt; - active set estimation method</font>
<a name="line301">301: </a><font color="#B22222">. -tao_bncg_as_tol &lt;r&gt; - tolerance used in Bertsekas active-set estimation</font>
<a name="line302">302: </a><font color="#B22222">. -tao_bncg_as_step &lt;r&gt; - trial step length used in Bertsekas active-set estimation</font>
<a name="line303">303: </a><font color="#B22222">. -tao_bncg_eps &lt;r&gt; - cutoff used for determining whether or not we restart based on steplength each iteration, as well as determining whether or not we continue using the last stepdirection. Defaults to machine precision.</font>
<a name="line304">304: </a><font color="#B22222">. -tao_bncg_theta &lt;r&gt; - convex combination parameter for the Broyden method</font>
<a name="line305">305: </a><font color="#B22222">. -tao_bncg_hz_eta &lt;r&gt; - cutoff tolerance for the beta term in the HZ, DK methods</font>
<a name="line306">306: </a><font color="#B22222">. -tao_bncg_dk_eta &lt;r&gt; - cutoff tolerance for the beta term in the HZ, DK methods</font>
<a name="line307">307: </a><font color="#B22222">. -tao_bncg_xi &lt;r&gt; - Multiplicative constant of the gamma term in the KD method</font>
<a name="line308">308: </a><font color="#B22222">. -tao_bncg_hz_theta &lt;r&gt; - Multiplicative constant of the theta term for the HZ method</font>
<a name="line309">309: </a><font color="#B22222">. -tao_bncg_bfgs_scale &lt;r&gt; - Scaling parameter of the bfgs contribution to the scalar Broyden method</font>
<a name="line310">310: </a><font color="#B22222">. -tao_bncg_dfp_scale &lt;r&gt; - Scaling parameter of the dfp contribution to the scalar Broyden method</font>
<a name="line311">311: </a><font color="#B22222">. -tao_bncg_diag_scaling &lt;b&gt; - Whether or not to use diagonal initialization/preconditioning for the CG methods. Default True.</font>
<a name="line312">312: </a><font color="#B22222">. -tao_bncg_dynamic_restart &lt;b&gt; - use dynamic restart strategy in the HZ, DK, KD methods</font>
<a name="line313">313: </a><font color="#B22222">. -tao_bncg_unscaled_restart &lt;b&gt; - whether or not to scale the gradient when doing gradient descent restarts</font>
<a name="line314">314: </a><font color="#B22222">. -tao_bncg_zeta &lt;r&gt; - Scaling parameter in the KD method</font>
<a name="line315">315: </a><font color="#B22222">. -tao_bncg_delta_min &lt;r&gt; - Minimum bound for rescaling during restarted gradient descent steps</font>
<a name="line316">316: </a><font color="#B22222">. -tao_bncg_delta_max &lt;r&gt; - Maximum bound for rescaling during restarted gradient descent steps</font>
<a name="line317">317: </a><font color="#B22222">. -tao_bncg_min_quad &lt;i&gt; - Number of quadratic-like steps in a row necessary to do a dynamic restart</font>
<a name="line318">318: </a><font color="#B22222">. -tao_bncg_min_restart_num &lt;i&gt; - This number, x, makes sure there is a gradient descent step every x*n iterations, where n is the dimension of the problem</font>
<a name="line319">319: </a><font color="#B22222">. -tao_bncg_spaced_restart &lt;b&gt; - whether or not to do gradient descent steps every x*n iterations</font>
<a name="line320">320: </a><font color="#B22222">. -tao_bncg_no_scaling &lt;b&gt; - If true, eliminates all scaling, including defaults.</font>
<a name="line321">321: </a><font color="#B22222">- -tao_bncg_neg_xi &lt;b&gt; - Whether or not to use negative xi in the KD method under certain conditions</font>

<a name="line323">323: </a><font color="#B22222">  Notes:</font>
<a name="line324">324: </a><font color="#B22222">    CG formulas are:</font>
<a name="line325">325: </a><font color="#B22222">+ "gd" - Gradient Descent</font>
<a name="line326">326: </a><font color="#B22222">. "fr" - Fletcher-Reeves</font>
<a name="line327">327: </a><font color="#B22222">. "pr" - Polak-Ribiere-Polyak</font>
<a name="line328">328: </a><font color="#B22222">. "prp" - Polak-Ribiere-Plus</font>
<a name="line329">329: </a><font color="#B22222">. "hs" - Hestenes-Steifel</font>
<a name="line330">330: </a><font color="#B22222">. "dy" - Dai-Yuan</font>
<a name="line331">331: </a><font color="#B22222">. "ssml_bfgs" - Self-Scaling Memoryless BFGS</font>
<a name="line332">332: </a><font color="#B22222">. "ssml_dfp"  - Self-Scaling Memoryless DFP</font>
<a name="line333">333: </a><font color="#B22222">. "ssml_brdn" - Self-Scaling Memoryless Broyden</font>
<a name="line334">334: </a><font color="#B22222">. "hz" - Hager-Zhang (CG_DESCENT 5.3)</font>
<a name="line335">335: </a><font color="#B22222">. "dk" - Dai-Kou (2013)</font>
<a name="line336">336: </a><font color="#B22222">- "kd" - Kou-Dai (2015)</font>

<a name="line338">338: </a><font color="#B22222">  Level: beginner</font>
<a name="line339">339: </a><font color="#B22222">M*/</font>

<a name="line341">341: </a><strong><font color="#4169E1"><a name="TaoCreate_BNCG"></a>PETSC_EXTERN <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoCreate_BNCG(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao)</font></strong>
<a name="line342">342: </a>{
<a name="line343">343: </a>  TAO_BNCG   *cg;
<a name="line344">344: </a>  const char *morethuente_type = <a href="../../../../../docs/manualpages/TaoLineSearch/TAOLINESEARCHMT.html">TAOLINESEARCHMT</a>;

<a name="line346">346: </a>  tao-&gt;ops-&gt;setup          = TaoSetUp_BNCG;
<a name="line347">347: </a>  tao-&gt;ops-&gt;solve          = TaoSolve_BNCG;
<a name="line348">348: </a>  tao-&gt;ops-&gt;view           = TaoView_BNCG;
<a name="line349">349: </a>  tao-&gt;ops-&gt;setfromoptions = TaoSetFromOptions_BNCG;
<a name="line350">350: </a>  tao-&gt;ops-&gt;destroy        = TaoDestroy_BNCG;

<a name="line352">352: </a>  <font color="#B22222">/* Override default settings (unless already changed) */</font>
<a name="line353">353: </a>  <font color="#4169E1">if</font> (!tao-&gt;max_it_changed) tao-&gt;max_it = 2000;
<a name="line354">354: </a>  <font color="#4169E1">if</font> (!tao-&gt;max_funcs_changed) tao-&gt;max_funcs = 4000;

<a name="line356">356: </a>  <font color="#B22222">/*  Note: nondefault values should be used for nonlinear conjugate gradient  */</font>
<a name="line357">357: </a>  <font color="#B22222">/*  method.  In particular, gtol should be less that 0.5; the value used in  */</font>
<a name="line358">358: </a>  <font color="#B22222">/*  Nocedal and Wright is 0.10.  We use the default values for the  */</font>
<a name="line359">359: </a>  <font color="#B22222">/*  linesearch because it seems to work better. */</font>
<a name="line360">360: </a>  <a href="../../../../../docs/manualpages/TaoLineSearch/TaoLineSearchCreate.html">TaoLineSearchCreate</a>(((<a href="../../../../../docs/manualpages/Sys/PetscObject.html">PetscObject</a>)tao)-&gt;comm, &amp;tao-&gt;linesearch);
<a name="line361">361: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectIncrementTabLevel.html">PetscObjectIncrementTabLevel</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html">PetscObject</a>)tao-&gt;linesearch, (<a href="../../../../../docs/manualpages/Sys/PetscObject.html">PetscObject</a>)tao, 1);
<a name="line362">362: </a>  <a href="../../../../../docs/manualpages/TaoLineSearch/TaoLineSearchSetType.html">TaoLineSearchSetType</a>(tao-&gt;linesearch, morethuente_type);
<a name="line363">363: </a>  <a href="../../../../../docs/manualpages/TaoLineSearch/TaoLineSearchUseTaoRoutines.html">TaoLineSearchUseTaoRoutines</a>(tao-&gt;linesearch, tao);

<a name="line365">365: </a>  <a href="../../../../../docs/manualpages/Sys/PetscNew.html">PetscNew</a>(&amp;cg);
<a name="line366">366: </a>  tao-&gt;data = (void *)cg;
<a name="line367">367: </a>  <a href="../../../../../docs/manualpages/KSP/KSPInitializePackage.html">KSPInitializePackage</a>();
<a name="line368">368: </a>  <a href="../../../../../docs/manualpages/Mat/MatCreate.html">MatCreate</a>(<a href="../../../../../docs/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html">PetscObject</a>)tao), &amp;cg-&gt;B);
<a name="line369">369: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectIncrementTabLevel.html">PetscObjectIncrementTabLevel</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html">PetscObject</a>)cg-&gt;B, (<a href="../../../../../docs/manualpages/Sys/PetscObject.html">PetscObject</a>)tao, 1);
<a name="line370">370: </a>  <a href="../../../../../docs/manualpages/Mat/MatSetType.html">MatSetType</a>(cg-&gt;B, MATLMVMDIAGBROYDEN);

<a name="line372">372: </a>  cg-&gt;pc = NULL;

<a name="line374">374: </a>  cg-&gt;dk_eta           = 0.5;
<a name="line375">375: </a>  cg-&gt;hz_eta           = 0.4;
<a name="line376">376: </a>  cg-&gt;dynamic_restart  = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;
<a name="line377">377: </a>  cg-&gt;unscaled_restart = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;
<a name="line378">378: </a>  cg-&gt;no_scaling       = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;
<a name="line379">379: </a>  cg-&gt;delta_min        = 1e-7;
<a name="line380">380: </a>  cg-&gt;delta_max        = 100;
<a name="line381">381: </a>  cg-&gt;theta            = 1.0;
<a name="line382">382: </a>  cg-&gt;hz_theta         = 1.0;
<a name="line383">383: </a>  cg-&gt;dfp_scale        = 1.0;
<a name="line384">384: </a>  cg-&gt;bfgs_scale       = 1.0;
<a name="line385">385: </a>  cg-&gt;zeta             = 0.1;
<a name="line386">386: </a>  cg-&gt;min_quad         = 6;
<a name="line387">387: </a>  cg-&gt;min_restart_num  = 6; <font color="#B22222">/* As in CG_DESCENT and KD2015*/</font>
<a name="line388">388: </a>  cg-&gt;xi               = 1.0;
<a name="line389">389: </a>  cg-&gt;neg_xi           = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html">PETSC_TRUE</a>;
<a name="line390">390: </a>  cg-&gt;spaced_restart   = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;
<a name="line391">391: </a>  cg-&gt;tol_quad         = 1e-8;
<a name="line392">392: </a>  cg-&gt;as_step          = 0.001;
<a name="line393">393: </a>  cg-&gt;as_tol           = 0.001;
<a name="line394">394: </a>  cg-&gt;eps_23           = PetscPowReal(PETSC_MACHINE_EPSILON, 2.0 / 3.0); <font color="#B22222">/* Just a little tighter*/</font>
<a name="line395">395: </a>  cg-&gt;as_type          = CG_AS_BERTSEKAS;
<a name="line396">396: </a>  cg-&gt;cg_type          = CG_SSML_BFGS;
<a name="line397">397: </a>  cg-&gt;alpha            = 1.0;
<a name="line398">398: </a>  cg-&gt;diag_scaling     = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html">PETSC_TRUE</a>;
<a name="line399">399: </a>  <font color="#4169E1">return</font> 0;
<a name="line400">400: </a>}

<a name="line402">402: </a><strong><font color="#4169E1"><a name="TaoBNCGResetUpdate"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoBNCGResetUpdate(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> gnormsq)</font></strong>
<a name="line403">403: </a>{
<a name="line404">404: </a>  TAO_BNCG *cg = (TAO_BNCG *)tao-&gt;data;
<a name="line405">405: </a>  <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> scaling;

<a name="line407">407: </a>  ++cg-&gt;resets;
<a name="line408">408: </a>  scaling = 2.0 * <a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(1.0, PetscAbsScalar(cg-&gt;f)) / <a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(gnormsq, cg-&gt;eps_23);
<a name="line409">409: </a>  scaling = <a href="../../../../../docs/manualpages/Sys/PetscMin.html">PetscMin</a>(cg-&gt;delta_max, <a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(cg-&gt;delta_min, scaling));
<a name="line410">410: </a>  <font color="#4169E1">if</font> (cg-&gt;unscaled_restart) {
<a name="line411">411: </a>    scaling = 1.0;
<a name="line412">412: </a>    ++cg-&gt;pure_gd_steps;
<a name="line413">413: </a>  }
<a name="line414">414: </a>  <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -scaling, 0.0, tao-&gt;gradient);
<a name="line415">415: </a>  <font color="#B22222">/* Also want to reset our diagonal scaling with each restart */</font>
<a name="line416">416: </a>  <font color="#4169E1">if</font> (cg-&gt;diag_scaling) <a href="../../../../../docs/manualpages/KSP/MatLMVMReset.html">MatLMVMReset</a>(cg-&gt;B, <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>);
<a name="line417">417: </a>  <font color="#4169E1">return</font> 0;
<a name="line418">418: </a>}

<a name="line420">420: </a><strong><font color="#4169E1"><a name="TaoBNCGCheckDynamicRestart"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoBNCGCheckDynamicRestart(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> stepsize, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> gd, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> gd_old, <a href="../../../../../docs/manualpages/Sys/PetscBool.html">PetscBool</a> *dynrestart, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> fold)</font></strong>
<a name="line421">421: </a>{
<a name="line422">422: </a>  TAO_BNCG *cg = (TAO_BNCG *)tao-&gt;data;
<a name="line423">423: </a>  <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> quadinterp;

<a name="line425">425: </a>  <font color="#4169E1">if</font> (cg-&gt;f &lt; cg-&gt;min_quad / 10) {
<a name="line426">426: </a>    *dynrestart = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;
<a name="line427">427: </a>    <font color="#4169E1">return</font> 0;
<a name="line428">428: </a>  } <font color="#B22222">/* just skip this since this strategy doesn't work well for functions near zero */</font>
<a name="line429">429: </a>  quadinterp = 2.0 * (cg-&gt;f - fold) / (stepsize * (gd + gd_old));
<a name="line430">430: </a>  <font color="#4169E1">if</font> (<a href="../../../../../docs/manualpages/Sys/PetscAbs.html">PetscAbs</a>(quadinterp - 1.0) &lt; cg-&gt;tol_quad) ++cg-&gt;iter_quad;
<a name="line431">431: </a>  <font color="#4169E1">else</font> {
<a name="line432">432: </a>    cg-&gt;iter_quad = 0;
<a name="line433">433: </a>    *dynrestart   = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;
<a name="line434">434: </a>  }
<a name="line435">435: </a>  <font color="#4169E1">if</font> (cg-&gt;iter_quad &gt;= cg-&gt;min_quad) {
<a name="line436">436: </a>    cg-&gt;iter_quad = 0;
<a name="line437">437: </a>    *dynrestart   = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html">PETSC_TRUE</a>;
<a name="line438">438: </a>  }
<a name="line439">439: </a>  <font color="#4169E1">return</font> 0;
<a name="line440">440: </a>}

<a name="line442">442: </a><strong><font color="#4169E1"><a name="TaoBNCGStepDirectionUpdate"></a>PETSC_INTERN <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoBNCGStepDirectionUpdate(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> gnorm2, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> step, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> fold, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> gnorm2_old, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> dnorm, <a href="../../../../../docs/manualpages/Sys/PetscBool.html">PetscBool</a> pcgd_fallback)</font></strong>
<a name="line443">443: </a>{
<a name="line444">444: </a>  TAO_BNCG *cg    = (TAO_BNCG *)tao-&gt;data;
<a name="line445">445: </a>  <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> gamma = 1.0, tau_k, beta;
<a name="line446">446: </a>  <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> tmp = 1.0, ynorm, ynorm2 = 1.0, snorm = 1.0, dk_yk = 1.0, gd;
<a name="line447">447: </a>  <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> gkp1_yk, gd_old, tau_bfgs, tau_dfp, gkp1D_yk, gtDg;
<a name="line448">448: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html">PetscInt</a>  dim;
<a name="line449">449: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html">PetscBool</a> cg_restart = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;

<a name="line451">451: </a>  <font color="#B22222">/* Local curvature check to see if we need to restart */</font>
<a name="line452">452: </a>  <font color="#4169E1">if</font> (tao-&gt;niter &gt;= 1 || tao-&gt;recycle) {
<a name="line453">453: </a>    <a href="../../../../../docs/manualpages/Vec/VecWAXPY.html">VecWAXPY</a>(cg-&gt;yk, -1.0, cg-&gt;G_old, tao-&gt;gradient);
<a name="line454">454: </a>    <a href="../../../../../docs/manualpages/Vec/VecNorm.html">VecNorm</a>(cg-&gt;yk, <a href="../../../../../docs/manualpages/Vec/NORM_2.html">NORM_2</a>, &amp;ynorm);
<a name="line455">455: </a>    ynorm2 = ynorm * ynorm;
<a name="line456">456: </a>    <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, tao-&gt;stepdirection, &amp;dk_yk);
<a name="line457">457: </a>    <font color="#4169E1">if</font> (step * dnorm &lt; PETSC_MACHINE_EPSILON || step * dk_yk &lt; PETSC_MACHINE_EPSILON) {
<a name="line458">458: </a>      cg_restart = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html">PETSC_TRUE</a>;
<a name="line459">459: </a>      ++cg-&gt;skipped_updates;
<a name="line460">460: </a>    }
<a name="line461">461: </a>    <font color="#4169E1">if</font> (cg-&gt;spaced_restart) {
<a name="line462">462: </a>      <a href="../../../../../docs/manualpages/Vec/VecGetSize.html">VecGetSize</a>(tao-&gt;gradient, &amp;dim);
<a name="line463">463: </a>      <font color="#4169E1">if</font> (tao-&gt;niter % (dim * cg-&gt;min_restart_num)) cg_restart = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html">PETSC_TRUE</a>;
<a name="line464">464: </a>    }
<a name="line465">465: </a>  }
<a name="line466">466: </a>  <font color="#B22222">/* If the user wants regular restarts, do it every 6n iterations, where n=dimension */</font>
<a name="line467">467: </a>  <font color="#4169E1">if</font> (cg-&gt;spaced_restart) {
<a name="line468">468: </a>    <a href="../../../../../docs/manualpages/Vec/VecGetSize.html">VecGetSize</a>(tao-&gt;gradient, &amp;dim);
<a name="line469">469: </a>    <font color="#4169E1">if</font> (0 == tao-&gt;niter % (6 * dim)) cg_restart = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html">PETSC_TRUE</a>;
<a name="line470">470: </a>  }
<a name="line471">471: </a>  <font color="#B22222">/* Compute the diagonal scaling vector if applicable */</font>
<a name="line472">472: </a>  <font color="#4169E1">if</font> (cg-&gt;diag_scaling) <a href="../../../../../docs/manualpages/KSP/MatLMVMUpdate.html">MatLMVMUpdate</a>(cg-&gt;B, tao-&gt;solution, tao-&gt;gradient);

<a name="line474">474: </a>  <font color="#B22222">/* A note on diagonal scaling (to be added to paper):</font>
<a name="line475">475: </a><font color="#B22222">   For the FR, PR, PRP, and DY methods, the diagonally scaled versions</font>
<a name="line476">476: </a><font color="#B22222">   must be derived as a preconditioned CG method rather than as</font>
<a name="line477">477: </a><font color="#B22222">   a Hessian initialization like in the Broyden methods. */</font>

<a name="line479">479: </a>  <font color="#B22222">/* In that case, one writes the objective function as</font>
<a name="line480">480: </a><font color="#B22222">   f(x) \equiv f(Ay). Gradient evaluations yield g(x_k) = A g(Ay_k) = A g(x_k).</font>
<a name="line481">481: </a><font color="#B22222">   Furthermore, the direction d_k \equiv (x_k - x_{k-1})/step according to</font>
<a name="line482">482: </a><font color="#B22222">   HZ (2006) becomes A^{-1} d_k, such that d_k^T g_k remains the</font>
<a name="line483">483: </a><font color="#B22222">   same under preconditioning. Note that A is diagonal, such that A^T = A. */</font>

<a name="line485">485: </a>  <font color="#B22222">/* This yields questions like what the dot product d_k^T y_k</font>
<a name="line486">486: </a><font color="#B22222">   should look like. HZ mistakenly treats that as the same under</font>
<a name="line487">487: </a><font color="#B22222">   preconditioning, but that is not necessarily true. */</font>

<a name="line489">489: </a>  <font color="#B22222">/* Observe y_k \equiv g_k - g_{k-1}, and under the P.C. transformation,</font>
<a name="line490">490: </a><font color="#B22222">   we get d_k^T y_k = (d_k^T A_k^{-T} A_k g_k - d_k^T A_k^{-T} A_{k-1} g_{k-1}),</font>
<a name="line491">491: </a><font color="#B22222">   yielding d_k^T y_k = d_k^T g_k - d_k^T (A_k^{-T} A_{k-1} g_{k-1}), which is</font>
<a name="line492">492: </a><font color="#B22222">   NOT the same if our preconditioning matrix is updated between iterations.</font>
<a name="line493">493: </a><font color="#B22222">   This same issue is found when considering dot products of the form g_{k+1}^T y_k. */</font>

<a name="line495">495: </a>  <font color="#B22222">/* Compute CG step direction */</font>
<a name="line496">496: </a>  <font color="#4169E1">if</font> (cg_restart) {
<a name="line497">497: </a>    TaoBNCGResetUpdate(tao, gnorm2);
<a name="line498">498: </a>  } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (pcgd_fallback) {
<a name="line499">499: </a>    <font color="#B22222">/* Just like preconditioned CG */</font>
<a name="line500">500: </a>    <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line501">501: </a>    <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -1.0, 0.0, cg-&gt;g_work);
<a name="line502">502: </a>  } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (ynorm2 &gt; PETSC_MACHINE_EPSILON) {
<a name="line503">503: </a>    <font color="#4169E1">switch</font> (cg-&gt;cg_type) {
<a name="line504">504: </a>    <font color="#4169E1">case</font> CG_PCGradientDescent:
<a name="line505">505: </a>      <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line506">506: </a>        <font color="#4169E1">if</font> (!cg-&gt;no_scaling) {
<a name="line507">507: </a>          cg-&gt;sts = step * step * dnorm * dnorm;
<a name="line508">508: </a>          TaoBNCGComputeScalarScaling(ynorm2, step * dk_yk, cg-&gt;sts, &amp;tau_k, cg-&gt;alpha);
<a name="line509">509: </a>        } <font color="#4169E1">else</font> {
<a name="line510">510: </a>          tau_k = 1.0;
<a name="line511">511: </a>          ++cg-&gt;pure_gd_steps;
<a name="line512">512: </a>        }
<a name="line513">513: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -tau_k, 0.0, tao-&gt;gradient);
<a name="line514">514: </a>      } <font color="#4169E1">else</font> {
<a name="line515">515: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line516">516: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -1.0, 0.0, cg-&gt;g_work);
<a name="line517">517: </a>      }
<a name="line518">518: </a>      <font color="#4169E1">break</font>;

<a name="line520">520: </a>    <font color="#4169E1">case</font> CG_HestenesStiefel:
<a name="line521">521: </a>      <font color="#B22222">/* Classic Hestenes-Stiefel method, modified with scalar and diagonal preconditioning. */</font>
<a name="line522">522: </a>      <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line523">523: </a>        cg-&gt;sts = step * step * dnorm * dnorm;
<a name="line524">524: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, tao-&gt;gradient, &amp;gkp1_yk);
<a name="line525">525: </a>        TaoBNCGComputeScalarScaling(ynorm2, step * dk_yk, cg-&gt;sts, &amp;tau_k, cg-&gt;alpha);
<a name="line526">526: </a>        beta = tau_k * gkp1_yk / dk_yk;
<a name="line527">527: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -tau_k, beta, tao-&gt;gradient);
<a name="line528">528: </a>      } <font color="#4169E1">else</font> {
<a name="line529">529: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line530">530: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, cg-&gt;g_work, &amp;gkp1_yk);
<a name="line531">531: </a>        beta = gkp1_yk / dk_yk;
<a name="line532">532: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -1.0, beta, cg-&gt;g_work);
<a name="line533">533: </a>      }
<a name="line534">534: </a>      <font color="#4169E1">break</font>;

<a name="line536">536: </a>    <font color="#4169E1">case</font> CG_FletcherReeves:
<a name="line537">537: </a>      <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, cg-&gt;G_old, &amp;gnorm2_old);
<a name="line538">538: </a>      <a href="../../../../../docs/manualpages/Vec/VecWAXPY.html">VecWAXPY</a>(cg-&gt;yk, -1.0, cg-&gt;G_old, tao-&gt;gradient);
<a name="line539">539: </a>      <a href="../../../../../docs/manualpages/Vec/VecNorm.html">VecNorm</a>(cg-&gt;yk, <a href="../../../../../docs/manualpages/Vec/NORM_2.html">NORM_2</a>, &amp;ynorm);
<a name="line540">540: </a>      ynorm2 = ynorm * ynorm;
<a name="line541">541: </a>      <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, tao-&gt;stepdirection, &amp;dk_yk);
<a name="line542">542: </a>      <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line543">543: </a>        TaoBNCGComputeScalarScaling(ynorm2, step * dk_yk, step * step * dnorm * dnorm, &amp;tau_k, cg-&gt;alpha);
<a name="line544">544: </a>        beta = tau_k * gnorm2 / gnorm2_old;
<a name="line545">545: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -tau_k, beta, tao-&gt;gradient);
<a name="line546">546: </a>      } <font color="#4169E1">else</font> {
<a name="line547">547: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, cg-&gt;g_work, &amp;gnorm2_old); <font color="#B22222">/* Before it's updated */</font>
<a name="line548">548: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line549">549: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;gradient, cg-&gt;g_work, &amp;tmp);
<a name="line550">550: </a>        beta = tmp / gnorm2_old;
<a name="line551">551: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -1.0, beta, cg-&gt;g_work);
<a name="line552">552: </a>      }
<a name="line553">553: </a>      <font color="#4169E1">break</font>;

<a name="line555">555: </a>    <font color="#4169E1">case</font> CG_PolakRibierePolyak:
<a name="line556">556: </a>      snorm = step * dnorm;
<a name="line557">557: </a>      <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line558">558: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, cg-&gt;G_old, &amp;gnorm2_old);
<a name="line559">559: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, tao-&gt;gradient, &amp;gkp1_yk);
<a name="line560">560: </a>        TaoBNCGComputeScalarScaling(ynorm2, step * dk_yk, snorm * snorm, &amp;tau_k, cg-&gt;alpha);
<a name="line561">561: </a>        beta = tau_k * gkp1_yk / gnorm2_old;
<a name="line562">562: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -tau_k, beta, tao-&gt;gradient);
<a name="line563">563: </a>      } <font color="#4169E1">else</font> {
<a name="line564">564: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, cg-&gt;g_work, &amp;gnorm2_old);
<a name="line565">565: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line566">566: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;g_work, cg-&gt;yk, &amp;gkp1_yk);
<a name="line567">567: </a>        beta = gkp1_yk / gnorm2_old;
<a name="line568">568: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -1.0, beta, cg-&gt;g_work);
<a name="line569">569: </a>      }
<a name="line570">570: </a>      <font color="#4169E1">break</font>;

<a name="line572">572: </a>    <font color="#4169E1">case</font> CG_PolakRibierePlus:
<a name="line573">573: </a>      <a href="../../../../../docs/manualpages/Vec/VecWAXPY.html">VecWAXPY</a>(cg-&gt;yk, -1.0, cg-&gt;G_old, tao-&gt;gradient);
<a name="line574">574: </a>      <a href="../../../../../docs/manualpages/Vec/VecNorm.html">VecNorm</a>(cg-&gt;yk, <a href="../../../../../docs/manualpages/Vec/NORM_2.html">NORM_2</a>, &amp;ynorm);
<a name="line575">575: </a>      ynorm2 = ynorm * ynorm;
<a name="line576">576: </a>      <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line577">577: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, cg-&gt;G_old, &amp;gnorm2_old);
<a name="line578">578: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, tao-&gt;gradient, &amp;gkp1_yk);
<a name="line579">579: </a>        TaoBNCGComputeScalarScaling(ynorm2, step * dk_yk, snorm * snorm, &amp;tau_k, cg-&gt;alpha);
<a name="line580">580: </a>        beta = tau_k * gkp1_yk / gnorm2_old;
<a name="line581">581: </a>        beta = <a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(beta, 0.0);
<a name="line582">582: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -tau_k, beta, tao-&gt;gradient);
<a name="line583">583: </a>      } <font color="#4169E1">else</font> {
<a name="line584">584: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, cg-&gt;g_work, &amp;gnorm2_old); <font color="#B22222">/* Old gtDg */</font>
<a name="line585">585: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line586">586: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;g_work, cg-&gt;yk, &amp;gkp1_yk);
<a name="line587">587: </a>        beta = gkp1_yk / gnorm2_old;
<a name="line588">588: </a>        beta = <a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(beta, 0.0);
<a name="line589">589: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -1.0, beta, cg-&gt;g_work);
<a name="line590">590: </a>      }
<a name="line591">591: </a>      <font color="#4169E1">break</font>;

<a name="line593">593: </a>    <font color="#4169E1">case</font> CG_DaiYuan:
<a name="line594">594: </a>      <font color="#B22222">/* Dai, Yu-Hong, and Yaxiang Yuan. "A nonlinear conjugate gradient method with a strong global convergence property."</font>
<a name="line595">595: </a><font color="#B22222">         SIAM Journal on optimization 10, no. 1 (1999): 177-182. */</font>
<a name="line596">596: </a>      <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line597">597: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;stepdirection, tao-&gt;gradient, &amp;gd);
<a name="line598">598: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, tao-&gt;stepdirection, &amp;gd_old);
<a name="line599">599: </a>        TaoBNCGComputeScalarScaling(ynorm2, step * dk_yk, cg-&gt;yts, &amp;tau_k, cg-&gt;alpha);
<a name="line600">600: </a>        beta = tau_k * gnorm2 / (gd - gd_old);
<a name="line601">601: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -tau_k, beta, tao-&gt;gradient);
<a name="line602">602: </a>      } <font color="#4169E1">else</font> {
<a name="line603">603: </a>        <a href="../../../../../docs/manualpages/Mat/MatMult.html">MatMult</a>(cg-&gt;B, tao-&gt;stepdirection, cg-&gt;d_work);
<a name="line604">604: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line605">605: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;g_work, tao-&gt;gradient, &amp;gtDg);
<a name="line606">606: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;stepdirection, cg-&gt;G_old, &amp;gd_old);
<a name="line607">607: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;d_work, cg-&gt;g_work, &amp;dk_yk);
<a name="line608">608: </a>        dk_yk = dk_yk - gd_old;
<a name="line609">609: </a>        beta  = gtDg / dk_yk;
<a name="line610">610: </a>        <a href="../../../../../docs/manualpages/Vec/VecScale.html">VecScale</a>(cg-&gt;d_work, beta);
<a name="line611">611: </a>        <a href="../../../../../docs/manualpages/Vec/VecWAXPY.html">VecWAXPY</a>(tao-&gt;stepdirection, -1.0, cg-&gt;g_work, cg-&gt;d_work);
<a name="line612">612: </a>      }
<a name="line613">613: </a>      <font color="#4169E1">break</font>;

<a name="line615">615: </a>    <font color="#4169E1">case</font> CG_HagerZhang:
<a name="line616">616: </a>      <font color="#B22222">/* Hager, William W., and Hongchao Zhang. "Algorithm 851: CG_DESCENT, a conjugate gradient method with guaranteed descent."</font>
<a name="line617">617: </a><font color="#B22222">         ACM Transactions on Mathematical Software (TOMS) 32, no. 1 (2006): 113-137. */</font>
<a name="line618">618: </a>      <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;gradient, tao-&gt;stepdirection, &amp;gd);
<a name="line619">619: </a>      <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, tao-&gt;stepdirection, &amp;gd_old);
<a name="line620">620: </a>      <a href="../../../../../docs/manualpages/Vec/VecWAXPY.html">VecWAXPY</a>(cg-&gt;sk, -1.0, cg-&gt;X_old, tao-&gt;solution);
<a name="line621">621: </a>      snorm   = dnorm * step;
<a name="line622">622: </a>      cg-&gt;yts = step * dk_yk;
<a name="line623">623: </a>      <font color="#4169E1">if</font> (cg-&gt;use_dynamic_restart) TaoBNCGCheckDynamicRestart(tao, step, gd, gd_old, &amp;cg-&gt;dynamic_restart, fold);
<a name="line624">624: </a>      <font color="#4169E1">if</font> (cg-&gt;dynamic_restart) {
<a name="line625">625: </a>        TaoBNCGResetUpdate(tao, gnorm2);
<a name="line626">626: </a>      } <font color="#4169E1">else</font> {
<a name="line627">627: </a>        <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line628">628: </a>          <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, tao-&gt;gradient, &amp;gkp1_yk);
<a name="line629">629: </a>          TaoBNCGComputeScalarScaling(ynorm2, cg-&gt;yts, snorm * snorm, &amp;tau_k, cg-&gt;alpha);
<a name="line630">630: </a>          <font color="#B22222">/* Supplying cg-&gt;alpha = -1.0 will give the CG_DESCENT 5.3 special case of tau_k = 1.0 */</font>
<a name="line631">631: </a>          tmp  = gd / dk_yk;
<a name="line632">632: </a>          beta = tau_k * (gkp1_yk / dk_yk - ynorm2 * gd / (dk_yk * dk_yk));
<a name="line633">633: </a>          <font color="#B22222">/* Bound beta as in CG_DESCENT 5.3, as implemented, with the third comparison from DK 2013 */</font>
<a name="line634">634: </a>          beta = <a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(<a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(beta, cg-&gt;hz_eta * tau_k * gd_old / (dnorm * dnorm)), cg-&gt;dk_eta * tau_k * gd / (dnorm * dnorm));
<a name="line635">635: </a>          <font color="#B22222">/* d &lt;- -t*g + beta*t*d */</font>
<a name="line636">636: </a>          <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -tau_k, beta, tao-&gt;gradient);
<a name="line637">637: </a>        } <font color="#4169E1">else</font> {
<a name="line638">638: </a>          <font color="#B22222">/* We have diagonal scaling enabled and are taking a diagonally-scaled memoryless BFGS step */</font>
<a name="line639">639: </a>          cg-&gt;yty = ynorm2;
<a name="line640">640: </a>          cg-&gt;sts = snorm * snorm;
<a name="line641">641: </a>          <font color="#B22222">/* Apply the diagonal scaling to all my vectors */</font>
<a name="line642">642: </a>          <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line643">643: </a>          <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, cg-&gt;yk, cg-&gt;y_work);
<a name="line644">644: </a>          <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;stepdirection, cg-&gt;d_work);
<a name="line645">645: </a>          <font color="#B22222">/* Construct the constant ytDgkp1 */</font>
<a name="line646">646: </a>          <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, cg-&gt;g_work, &amp;gkp1_yk);
<a name="line647">647: </a>          <font color="#B22222">/* Construct the constant for scaling Dkyk in the update */</font>
<a name="line648">648: </a>          tmp = gd / dk_yk;
<a name="line649">649: </a>          <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, cg-&gt;y_work, &amp;tau_k);
<a name="line650">650: </a>          tau_k = -tau_k * gd / (dk_yk * dk_yk);
<a name="line651">651: </a>          <font color="#B22222">/* beta is the constant which adds the dk contribution */</font>
<a name="line652">652: </a>          beta = gkp1_yk / dk_yk + cg-&gt;hz_theta * tau_k; <font color="#B22222">/* HZ; (1.15) from DK 2013 */</font>
<a name="line653">653: </a>          <font color="#B22222">/* From HZ2013, modified to account for diagonal scaling*/</font>
<a name="line654">654: </a>          <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, cg-&gt;d_work, &amp;gd_old);
<a name="line655">655: </a>          <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;stepdirection, cg-&gt;g_work, &amp;gd);
<a name="line656">656: </a>          beta = <a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(<a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(beta, cg-&gt;hz_eta * gd_old / (dnorm * dnorm)), cg-&gt;dk_eta * gd / (dnorm * dnorm));
<a name="line657">657: </a>          <font color="#B22222">/* Do the update */</font>
<a name="line658">658: </a>          <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -1.0, beta, cg-&gt;g_work);
<a name="line659">659: </a>        }
<a name="line660">660: </a>      }
<a name="line661">661: </a>      <font color="#4169E1">break</font>;

<a name="line663">663: </a>    <font color="#4169E1">case</font> CG_DaiKou:
<a name="line664">664: </a>      <font color="#B22222">/* Dai, Yu-Hong, and Cai-Xia Kou. "A nonlinear conjugate gradient algorithm with an optimal property and an improved Wolfe line search."</font>
<a name="line665">665: </a><font color="#B22222">         SIAM Journal on Optimization 23, no. 1 (2013): 296-320. */</font>
<a name="line666">666: </a>      <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;gradient, tao-&gt;stepdirection, &amp;gd);
<a name="line667">667: </a>      <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, tao-&gt;stepdirection, &amp;gd_old);
<a name="line668">668: </a>      <a href="../../../../../docs/manualpages/Vec/VecWAXPY.html">VecWAXPY</a>(cg-&gt;sk, -1.0, cg-&gt;X_old, tao-&gt;solution);
<a name="line669">669: </a>      snorm   = step * dnorm;
<a name="line670">670: </a>      cg-&gt;yts = dk_yk * step;
<a name="line671">671: </a>      <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line672">672: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, tao-&gt;gradient, &amp;gkp1_yk);
<a name="line673">673: </a>        TaoBNCGComputeScalarScaling(ynorm2, cg-&gt;yts, snorm * snorm, &amp;tau_k, cg-&gt;alpha);
<a name="line674">674: </a>        <font color="#B22222">/* Use cg-&gt;alpha = -1.0 to get tau_k = 1.0 as in CG_DESCENT 5.3 */</font>
<a name="line675">675: </a>        tmp  = gd / dk_yk;
<a name="line676">676: </a>        beta = tau_k * (gkp1_yk / dk_yk - ynorm2 * gd / (dk_yk * dk_yk) + gd / (dnorm * dnorm)) - step * gd / dk_yk;
<a name="line677">677: </a>        beta = <a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(<a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(beta, cg-&gt;hz_eta * tau_k * gd_old / (dnorm * dnorm)), cg-&gt;dk_eta * tau_k * gd / (dnorm * dnorm));
<a name="line678">678: </a>        <font color="#B22222">/* d &lt;- -t*g + beta*t*d */</font>
<a name="line679">679: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBYPCZ.html">VecAXPBYPCZ</a>(tao-&gt;stepdirection, -tau_k, 0.0, beta, tao-&gt;gradient, cg-&gt;yk);
<a name="line680">680: </a>      } <font color="#4169E1">else</font> {
<a name="line681">681: </a>        <font color="#B22222">/* We have diagonal scaling enabled and are taking a diagonally-scaled memoryless BFGS step */</font>
<a name="line682">682: </a>        cg-&gt;yty = ynorm2;
<a name="line683">683: </a>        cg-&gt;sts = snorm * snorm;
<a name="line684">684: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line685">685: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, cg-&gt;yk, cg-&gt;y_work);
<a name="line686">686: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;stepdirection, cg-&gt;d_work);
<a name="line687">687: </a>        <font color="#B22222">/* Construct the constant ytDgkp1 */</font>
<a name="line688">688: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, cg-&gt;g_work, &amp;gkp1_yk);
<a name="line689">689: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, cg-&gt;y_work, &amp;tau_k);
<a name="line690">690: </a>        tau_k = tau_k * gd / (dk_yk * dk_yk);
<a name="line691">691: </a>        tmp   = gd / dk_yk;
<a name="line692">692: </a>        <font color="#B22222">/* beta is the constant which adds the dk contribution */</font>
<a name="line693">693: </a>        beta = gkp1_yk / dk_yk - step * tmp - tau_k;
<a name="line694">694: </a>        <font color="#B22222">/* Update this for the last term in beta */</font>
<a name="line695">695: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;y_work, tao-&gt;stepdirection, &amp;dk_yk);
<a name="line696">696: </a>        beta += tmp * dk_yk / (dnorm * dnorm); <font color="#B22222">/* projection of y_work onto dk */</font>
<a name="line697">697: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;stepdirection, cg-&gt;g_work, &amp;gd);
<a name="line698">698: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, cg-&gt;d_work, &amp;gd_old);
<a name="line699">699: </a>        beta = <a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(<a href="../../../../../docs/manualpages/Sys/PetscMax.html">PetscMax</a>(beta, cg-&gt;hz_eta * gd_old / (dnorm * dnorm)), cg-&gt;dk_eta * gd / (dnorm * dnorm));
<a name="line700">700: </a>        <font color="#B22222">/* Do the update */</font>
<a name="line701">701: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -1.0, beta, cg-&gt;g_work);
<a name="line702">702: </a>      }
<a name="line703">703: </a>      <font color="#4169E1">break</font>;

<a name="line705">705: </a>    <font color="#4169E1">case</font> CG_KouDai:
<a name="line706">706: </a>      <font color="#B22222">/* Kou, Cai-Xia, and Yu-Hong Dai. "A modified self-scaling memoryless Broyden-Fletcher-Goldfarb-Shanno method for unconstrained optimization."</font>
<a name="line707">707: </a><font color="#B22222">         Journal of Optimization Theory and Applications 165, no. 1 (2015): 209-224. */</font>
<a name="line708">708: </a>      <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;gradient, tao-&gt;stepdirection, &amp;gd);
<a name="line709">709: </a>      <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;G_old, tao-&gt;stepdirection, &amp;gd_old);
<a name="line710">710: </a>      <a href="../../../../../docs/manualpages/Vec/VecWAXPY.html">VecWAXPY</a>(cg-&gt;sk, -1.0, cg-&gt;X_old, tao-&gt;solution);
<a name="line711">711: </a>      snorm   = step * dnorm;
<a name="line712">712: </a>      cg-&gt;yts = dk_yk * step;
<a name="line713">713: </a>      <font color="#4169E1">if</font> (cg-&gt;use_dynamic_restart) TaoBNCGCheckDynamicRestart(tao, step, gd, gd_old, &amp;cg-&gt;dynamic_restart, fold);
<a name="line714">714: </a>      <font color="#4169E1">if</font> (cg-&gt;dynamic_restart) {
<a name="line715">715: </a>        TaoBNCGResetUpdate(tao, gnorm2);
<a name="line716">716: </a>      } <font color="#4169E1">else</font> {
<a name="line717">717: </a>        <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line718">718: </a>          <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, tao-&gt;gradient, &amp;gkp1_yk);
<a name="line719">719: </a>          TaoBNCGComputeScalarScaling(ynorm2, cg-&gt;yts, snorm * snorm, &amp;tau_k, cg-&gt;alpha);
<a name="line720">720: </a>          beta = tau_k * (gkp1_yk / dk_yk - ynorm2 * gd / (dk_yk * dk_yk)) - step * gd / dk_yk;
<a name="line721">721: </a>          <font color="#4169E1">if</font> (beta &lt; cg-&gt;zeta * tau_k * gd / (dnorm * dnorm)) <font color="#B22222">/* 0.1 is KD's zeta parameter */</font>
<a name="line722">722: </a>          {
<a name="line723">723: </a>            beta  = cg-&gt;zeta * tau_k * gd / (dnorm * dnorm);
<a name="line724">724: </a>            gamma = 0.0;
<a name="line725">725: </a>          } <font color="#4169E1">else</font> {
<a name="line726">726: </a>            <font color="#4169E1">if</font> (gkp1_yk &lt; 0 &amp;&amp; cg-&gt;neg_xi) gamma = -1.0 * gd / dk_yk;
<a name="line727">727: </a>            <font color="#B22222">/* This seems to be very effective when there's no tau_k scaling.</font>
<a name="line728">728: </a><font color="#B22222">               This guarantees a large descent step every iteration, going through DK 2015 Lemma 3.1's proof but allowing for negative xi */</font>
<a name="line729">729: </a>            <font color="#4169E1">else</font> gamma = cg-&gt;xi * gd / dk_yk;
<a name="line730">730: </a>          }
<a name="line731">731: </a>          <font color="#B22222">/* d &lt;- -t*g + beta*t*d + t*tmp*yk */</font>
<a name="line732">732: </a>          <a href="../../../../../docs/manualpages/Vec/VecAXPBYPCZ.html">VecAXPBYPCZ</a>(tao-&gt;stepdirection, -tau_k, gamma * tau_k, beta, tao-&gt;gradient, cg-&gt;yk);
<a name="line733">733: </a>        } <font color="#4169E1">else</font> {
<a name="line734">734: </a>          <font color="#B22222">/* We have diagonal scaling enabled and are taking a diagonally-scaled memoryless BFGS step */</font>
<a name="line735">735: </a>          cg-&gt;yty = ynorm2;
<a name="line736">736: </a>          cg-&gt;sts = snorm * snorm;
<a name="line737">737: </a>          <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line738">738: </a>          <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, cg-&gt;yk, cg-&gt;y_work);
<a name="line739">739: </a>          <font color="#B22222">/* Construct the constant ytDgkp1 */</font>
<a name="line740">740: </a>          <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, cg-&gt;g_work, &amp;gkp1D_yk);
<a name="line741">741: </a>          <font color="#B22222">/* Construct the constant for scaling Dkyk in the update */</font>
<a name="line742">742: </a>          gamma = gd / dk_yk;
<a name="line743">743: </a>          <font color="#B22222">/* tau_k = -ytDy/(ytd)^2 * gd */</font>
<a name="line744">744: </a>          <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, cg-&gt;y_work, &amp;tau_k);
<a name="line745">745: </a>          tau_k = tau_k * gd / (dk_yk * dk_yk);
<a name="line746">746: </a>          <font color="#B22222">/* beta is the constant which adds the d_k contribution */</font>
<a name="line747">747: </a>          beta = gkp1D_yk / dk_yk - step * gamma - tau_k;
<a name="line748">748: </a>          <font color="#B22222">/* Here is the requisite check */</font>
<a name="line749">749: </a>          <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;stepdirection, cg-&gt;g_work, &amp;tmp);
<a name="line750">750: </a>          <font color="#4169E1">if</font> (cg-&gt;neg_xi) {
<a name="line751">751: </a>            <font color="#B22222">/* modified KD implementation */</font>
<a name="line752">752: </a>            <font color="#4169E1">if</font> (gkp1D_yk / dk_yk &lt; 0) gamma = -1.0 * gd / dk_yk;
<a name="line753">753: </a>            <font color="#4169E1">else</font> gamma = cg-&gt;xi * gd / dk_yk;
<a name="line754">754: </a>            <font color="#4169E1">if</font> (beta &lt; cg-&gt;zeta * tmp / (dnorm * dnorm)) {
<a name="line755">755: </a>              beta  = cg-&gt;zeta * tmp / (dnorm * dnorm);
<a name="line756">756: </a>              gamma = 0.0;
<a name="line757">757: </a>            }
<a name="line758">758: </a>          } <font color="#4169E1">else</font> { <font color="#B22222">/* original KD 2015 implementation */</font>
<a name="line759">759: </a>            <font color="#4169E1">if</font> (beta &lt; cg-&gt;zeta * tmp / (dnorm * dnorm)) {
<a name="line760">760: </a>              beta  = cg-&gt;zeta * tmp / (dnorm * dnorm);
<a name="line761">761: </a>              gamma = 0.0;
<a name="line762">762: </a>            } <font color="#4169E1">else</font> gamma = cg-&gt;xi * gd / dk_yk;
<a name="line763">763: </a>          }
<a name="line764">764: </a>          <font color="#B22222">/* Do the update in two steps */</font>
<a name="line765">765: </a>          <a href="../../../../../docs/manualpages/Vec/VecAXPBY.html">VecAXPBY</a>(tao-&gt;stepdirection, -1.0, beta, cg-&gt;g_work);
<a name="line766">766: </a>          <a href="../../../../../docs/manualpages/Vec/VecAXPY.html">VecAXPY</a>(tao-&gt;stepdirection, gamma, cg-&gt;y_work);
<a name="line767">767: </a>        }
<a name="line768">768: </a>      }
<a name="line769">769: </a>      <font color="#4169E1">break</font>;

<a name="line771">771: </a>    <font color="#4169E1">case</font> CG_SSML_BFGS:
<a name="line772">772: </a>      <font color="#B22222">/* Perry, J. M. "A class of conjugate gradient algorithms with a two-step variable-metric memory."</font>
<a name="line773">773: </a><font color="#B22222">         Discussion Papers 269 (1977). */</font>
<a name="line774">774: </a>      <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;gradient, tao-&gt;stepdirection, &amp;gd);
<a name="line775">775: </a>      <a href="../../../../../docs/manualpages/Vec/VecWAXPY.html">VecWAXPY</a>(cg-&gt;sk, -1.0, cg-&gt;X_old, tao-&gt;solution);
<a name="line776">776: </a>      snorm   = step * dnorm;
<a name="line777">777: </a>      cg-&gt;yts = dk_yk * step;
<a name="line778">778: </a>      cg-&gt;yty = ynorm2;
<a name="line779">779: </a>      cg-&gt;sts = snorm * snorm;
<a name="line780">780: </a>      <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line781">781: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, tao-&gt;gradient, &amp;gkp1_yk);
<a name="line782">782: </a>        TaoBNCGComputeScalarScaling(cg-&gt;yty, cg-&gt;yts, cg-&gt;sts, &amp;tau_k, cg-&gt;alpha);
<a name="line783">783: </a>        tmp  = gd / dk_yk;
<a name="line784">784: </a>        beta = tau_k * (gkp1_yk / dk_yk - cg-&gt;yty * gd / (dk_yk * dk_yk)) - step * tmp;
<a name="line785">785: </a>        <font color="#B22222">/* d &lt;- -t*g + beta*t*d + t*tmp*yk */</font>
<a name="line786">786: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBYPCZ.html">VecAXPBYPCZ</a>(tao-&gt;stepdirection, -tau_k, tmp * tau_k, beta, tao-&gt;gradient, cg-&gt;yk);
<a name="line787">787: </a>      } <font color="#4169E1">else</font> {
<a name="line788">788: </a>        <font color="#B22222">/* We have diagonal scaling enabled and are taking a diagonally-scaled memoryless BFGS step */</font>
<a name="line789">789: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line790">790: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, cg-&gt;yk, cg-&gt;y_work);
<a name="line791">791: </a>        <font color="#B22222">/* compute scalar gamma */</font>
<a name="line792">792: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;g_work, cg-&gt;yk, &amp;gkp1_yk);
<a name="line793">793: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;y_work, cg-&gt;yk, &amp;tmp);
<a name="line794">794: </a>        gamma = gd / dk_yk;
<a name="line795">795: </a>        <font color="#B22222">/* Compute scalar beta */</font>
<a name="line796">796: </a>        beta = (gkp1_yk / dk_yk - gd * tmp / (dk_yk * dk_yk)) - step * gd / dk_yk;
<a name="line797">797: </a>        <font color="#B22222">/* Compute stepdirection d_kp1 = gamma*Dkyk + beta*dk - Dkgkp1 */</font>
<a name="line798">798: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBYPCZ.html">VecAXPBYPCZ</a>(tao-&gt;stepdirection, -1.0, gamma, beta, cg-&gt;g_work, cg-&gt;y_work);
<a name="line799">799: </a>      }
<a name="line800">800: </a>      <font color="#4169E1">break</font>;

<a name="line802">802: </a>    <font color="#4169E1">case</font> CG_SSML_DFP:
<a name="line803">803: </a>      <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;gradient, tao-&gt;stepdirection, &amp;gd);
<a name="line804">804: </a>      <a href="../../../../../docs/manualpages/Vec/VecWAXPY.html">VecWAXPY</a>(cg-&gt;sk, -1.0, cg-&gt;X_old, tao-&gt;solution);
<a name="line805">805: </a>      snorm   = step * dnorm;
<a name="line806">806: </a>      cg-&gt;yts = dk_yk * step;
<a name="line807">807: </a>      cg-&gt;yty = ynorm2;
<a name="line808">808: </a>      cg-&gt;sts = snorm * snorm;
<a name="line809">809: </a>      <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line810">810: </a>        <font color="#B22222">/* Instead of a regular convex combination, we will solve a quadratic formula. */</font>
<a name="line811">811: </a>        TaoBNCGComputeScalarScaling(cg-&gt;yty, cg-&gt;yts, cg-&gt;sts, &amp;tau_k, cg-&gt;alpha);
<a name="line812">812: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, tao-&gt;gradient, &amp;gkp1_yk);
<a name="line813">813: </a>        tau_k = cg-&gt;dfp_scale * tau_k;
<a name="line814">814: </a>        tmp   = tau_k * gkp1_yk / cg-&gt;yty;
<a name="line815">815: </a>        beta  = -step * gd / dk_yk;
<a name="line816">816: </a>        <font color="#B22222">/* d &lt;- -t*g + beta*d + tmp*yk */</font>
<a name="line817">817: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBYPCZ.html">VecAXPBYPCZ</a>(tao-&gt;stepdirection, -tau_k, tmp, beta, tao-&gt;gradient, cg-&gt;yk);
<a name="line818">818: </a>      } <font color="#4169E1">else</font> {
<a name="line819">819: </a>        <font color="#B22222">/* We have diagonal scaling enabled and are taking a diagonally-scaled memoryless DFP step */</font>
<a name="line820">820: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line821">821: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, cg-&gt;yk, cg-&gt;y_work);
<a name="line822">822: </a>        <font color="#B22222">/* compute scalar gamma */</font>
<a name="line823">823: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;g_work, cg-&gt;yk, &amp;gkp1_yk);
<a name="line824">824: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;y_work, cg-&gt;yk, &amp;tmp);
<a name="line825">825: </a>        gamma = (gkp1_yk / tmp);
<a name="line826">826: </a>        <font color="#B22222">/* Compute scalar beta */</font>
<a name="line827">827: </a>        beta = -step * gd / dk_yk;
<a name="line828">828: </a>        <font color="#B22222">/* Compute stepdirection d_kp1 = gamma*Dkyk + beta*dk - Dkgkp1 */</font>
<a name="line829">829: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBYPCZ.html">VecAXPBYPCZ</a>(tao-&gt;stepdirection, -1.0, gamma, beta, cg-&gt;g_work, cg-&gt;y_work);
<a name="line830">830: </a>      }
<a name="line831">831: </a>      <font color="#4169E1">break</font>;

<a name="line833">833: </a>    <font color="#4169E1">case</font> CG_SSML_BROYDEN:
<a name="line834">834: </a>      <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;gradient, tao-&gt;stepdirection, &amp;gd);
<a name="line835">835: </a>      <a href="../../../../../docs/manualpages/Vec/VecWAXPY.html">VecWAXPY</a>(cg-&gt;sk, -1.0, cg-&gt;X_old, tao-&gt;solution);
<a name="line836">836: </a>      snorm   = step * dnorm;
<a name="line837">837: </a>      cg-&gt;yts = step * dk_yk;
<a name="line838">838: </a>      cg-&gt;yty = ynorm2;
<a name="line839">839: </a>      cg-&gt;sts = snorm * snorm;
<a name="line840">840: </a>      <font color="#4169E1">if</font> (!cg-&gt;diag_scaling) {
<a name="line841">841: </a>        <font color="#B22222">/* Instead of a regular convex combination, we will solve a quadratic formula. */</font>
<a name="line842">842: </a>        TaoBNCGComputeScalarScaling(cg-&gt;yty, step * dk_yk, snorm * snorm, &amp;tau_bfgs, cg-&gt;bfgs_scale);
<a name="line843">843: </a>        TaoBNCGComputeScalarScaling(cg-&gt;yty, step * dk_yk, snorm * snorm, &amp;tau_dfp, cg-&gt;dfp_scale);
<a name="line844">844: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;yk, tao-&gt;gradient, &amp;gkp1_yk);
<a name="line845">845: </a>        tau_k = cg-&gt;theta * tau_bfgs + (1.0 - cg-&gt;theta) * tau_dfp;
<a name="line846">846: </a>        <font color="#B22222">/* If bfgs_scale = 1.0, it should reproduce the bfgs tau_bfgs. If bfgs_scale = 0.0,</font>
<a name="line847">847: </a><font color="#B22222">           it should reproduce the tau_dfp scaling. Same with dfp_scale.   */</font>
<a name="line848">848: </a>        tmp  = cg-&gt;theta * tau_bfgs * gd / dk_yk + (1 - cg-&gt;theta) * tau_dfp * gkp1_yk / cg-&gt;yty;
<a name="line849">849: </a>        beta = cg-&gt;theta * tau_bfgs * (gkp1_yk / dk_yk - cg-&gt;yty * gd / (dk_yk * dk_yk)) - step * gd / dk_yk;
<a name="line850">850: </a>        <font color="#B22222">/* d &lt;- -t*g + beta*d + tmp*yk */</font>
<a name="line851">851: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBYPCZ.html">VecAXPBYPCZ</a>(tao-&gt;stepdirection, -tau_k, tmp, beta, tao-&gt;gradient, cg-&gt;yk);
<a name="line852">852: </a>      } <font color="#4169E1">else</font> {
<a name="line853">853: </a>        <font color="#B22222">/* We have diagonal scaling enabled */</font>
<a name="line854">854: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, tao-&gt;gradient, cg-&gt;g_work);
<a name="line855">855: </a>        <a href="../../../../../docs/manualpages/Mat/MatSolve.html">MatSolve</a>(cg-&gt;B, cg-&gt;yk, cg-&gt;y_work);
<a name="line856">856: </a>        <font color="#B22222">/* compute scalar gamma */</font>
<a name="line857">857: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;g_work, cg-&gt;yk, &amp;gkp1_yk);
<a name="line858">858: </a>        <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(cg-&gt;y_work, cg-&gt;yk, &amp;tmp);
<a name="line859">859: </a>        gamma = cg-&gt;theta * gd / dk_yk + (1 - cg-&gt;theta) * (gkp1_yk / tmp);
<a name="line860">860: </a>        <font color="#B22222">/* Compute scalar beta */</font>
<a name="line861">861: </a>        beta = cg-&gt;theta * (gkp1_yk / dk_yk - gd * tmp / (dk_yk * dk_yk)) - step * gd / dk_yk;
<a name="line862">862: </a>        <font color="#B22222">/* Compute stepdirection dkp1 = gamma*Dkyk + beta*dk - Dkgkp1 */</font>
<a name="line863">863: </a>        <a href="../../../../../docs/manualpages/Vec/VecAXPBYPCZ.html">VecAXPBYPCZ</a>(tao-&gt;stepdirection, -1.0, gamma, beta, cg-&gt;g_work, cg-&gt;y_work);
<a name="line864">864: </a>      }
<a name="line865">865: </a>      <font color="#4169E1">break</font>;

<a name="line867">867: </a><strong><font color="#FF0000">    default:</font></strong>
<a name="line868">868: </a>      <font color="#4169E1">break</font>;
<a name="line869">869: </a>    }
<a name="line870">870: </a>  }
<a name="line871">871: </a>  <font color="#4169E1">return</font> 0;
<a name="line872">872: </a>}

<a name="line874">874: </a><strong><font color="#4169E1"><a name="TaoBNCGConductIteration"></a>PETSC_INTERN <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoBNCGConductIteration(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao, <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a> gnorm)</font></strong>
<a name="line875">875: </a>{
<a name="line876">876: </a>  TAO_BNCG                    *cg        = (TAO_BNCG *)tao-&gt;data;
<a name="line877">877: </a>  TaoLineSearchConvergedReason ls_status = TAOLINESEARCH_CONTINUE_ITERATING;
<a name="line878">878: </a>  <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a>                    step = 1.0, gnorm2, gd, dnorm = 0.0;
<a name="line879">879: </a>  <a href="../../../../../docs/manualpages/Sys/PetscReal.html">PetscReal</a>                    gnorm2_old, f_old, resnorm, gnorm_old;
<a name="line880">880: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html">PetscBool</a>                    pcgd_fallback = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;

<a name="line882">882: </a>  <font color="#B22222">/* We are now going to perform a line search along the direction. */</font>
<a name="line883">883: </a>  <font color="#B22222">/* Store solution and gradient info before it changes */</font>
<a name="line884">884: </a>  <a href="../../../../../docs/manualpages/Vec/VecCopy.html">VecCopy</a>(tao-&gt;solution, cg-&gt;X_old);
<a name="line885">885: </a>  <a href="../../../../../docs/manualpages/Vec/VecCopy.html">VecCopy</a>(tao-&gt;gradient, cg-&gt;G_old);
<a name="line886">886: </a>  <a href="../../../../../docs/manualpages/Vec/VecCopy.html">VecCopy</a>(cg-&gt;unprojected_gradient, cg-&gt;unprojected_gradient_old);

<a name="line888">888: </a>  gnorm_old  = gnorm;
<a name="line889">889: </a>  gnorm2_old = gnorm_old * gnorm_old;
<a name="line890">890: </a>  f_old      = cg-&gt;f;
<a name="line891">891: </a>  <font color="#B22222">/* Perform bounded line search. If we are recycling a solution from a previous */</font>
<a name="line892">892: </a>  <font color="#B22222">/* <a href="../../../../../docs/manualpages/Tao/TaoSolve.html">TaoSolve</a>, then we want to immediately skip to calculating a new direction rather than performing a linesearch */</font>
<a name="line893">893: </a>  <font color="#4169E1">if</font> (!(tao-&gt;recycle &amp;&amp; 0 == tao-&gt;niter)) {
<a name="line894">894: </a>    <font color="#B22222">/* Above logic: the below code happens every iteration, except for the first iteration of a recycled <a href="../../../../../docs/manualpages/Tao/TaoSolve.html">TaoSolve</a> */</font>
<a name="line895">895: </a>    <a href="../../../../../docs/manualpages/TaoLineSearch/TaoLineSearchSetInitialStepLength.html">TaoLineSearchSetInitialStepLength</a>(tao-&gt;linesearch, 1.0);
<a name="line896">896: </a>    <a href="../../../../../docs/manualpages/TaoLineSearch/TaoLineSearchApply.html">TaoLineSearchApply</a>(tao-&gt;linesearch, tao-&gt;solution, &amp;cg-&gt;f, cg-&gt;unprojected_gradient, tao-&gt;stepdirection, &amp;step, &amp;ls_status);
<a name="line897">897: </a>    <a href="../../../../../docs/manualpages/Tao/TaoAddLineSearchCounts.html">TaoAddLineSearchCounts</a>(tao);

<a name="line899">899: </a>    <font color="#B22222">/*  Check linesearch failure */</font>
<a name="line900">900: </a>    <font color="#4169E1">if</font> (ls_status != TAOLINESEARCH_SUCCESS &amp;&amp; ls_status != TAOLINESEARCH_SUCCESS_USER) {
<a name="line901">901: </a>      ++cg-&gt;ls_fails;
<a name="line902">902: </a>      <font color="#4169E1">if</font> (cg-&gt;cg_type == CG_GradientDescent) {
<a name="line903">903: </a>        <font color="#B22222">/* Nothing left to do but fail out of the optimization */</font>
<a name="line904">904: </a>        step        = 0.0;
<a name="line905">905: </a>        tao-&gt;reason = <a href="../../../../../docs/manualpages/Tao/TaoConvergedReason.html">TAO_DIVERGED_LS_FAILURE</a>;
<a name="line906">906: </a>      } <font color="#4169E1">else</font> {
<a name="line907">907: </a>        <font color="#B22222">/* Restore previous point, perform preconditioned GD and regular GD steps at the last good point */</font>
<a name="line908">908: </a>        <a href="../../../../../docs/manualpages/Vec/VecCopy.html">VecCopy</a>(cg-&gt;X_old, tao-&gt;solution);
<a name="line909">909: </a>        <a href="../../../../../docs/manualpages/Vec/VecCopy.html">VecCopy</a>(cg-&gt;G_old, tao-&gt;gradient);
<a name="line910">910: </a>        <a href="../../../../../docs/manualpages/Vec/VecCopy.html">VecCopy</a>(cg-&gt;unprojected_gradient_old, cg-&gt;unprojected_gradient);
<a name="line911">911: </a>        gnorm  = gnorm_old;
<a name="line912">912: </a>        gnorm2 = gnorm2_old;
<a name="line913">913: </a>        cg-&gt;f  = f_old;

<a name="line915">915: </a>        <font color="#B22222">/* Fall back on preconditioned CG (so long as you're not already using it) */</font>
<a name="line916">916: </a>        <font color="#4169E1">if</font> (cg-&gt;cg_type != CG_PCGradientDescent &amp;&amp; cg-&gt;diag_scaling) {
<a name="line917">917: </a>          pcgd_fallback = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html">PETSC_TRUE</a>;
<a name="line918">918: </a>          TaoBNCGStepDirectionUpdate(tao, gnorm2, step, f_old, gnorm2_old, dnorm, pcgd_fallback);

<a name="line920">920: </a>          TaoBNCGResetUpdate(tao, gnorm2);
<a name="line921">921: </a>          TaoBNCGBoundStep(tao, cg-&gt;as_type, tao-&gt;stepdirection);

<a name="line923">923: </a>          <a href="../../../../../docs/manualpages/TaoLineSearch/TaoLineSearchSetInitialStepLength.html">TaoLineSearchSetInitialStepLength</a>(tao-&gt;linesearch, 1.0);
<a name="line924">924: </a>          <a href="../../../../../docs/manualpages/TaoLineSearch/TaoLineSearchApply.html">TaoLineSearchApply</a>(tao-&gt;linesearch, tao-&gt;solution, &amp;cg-&gt;f, cg-&gt;unprojected_gradient, tao-&gt;stepdirection, &amp;step, &amp;ls_status);
<a name="line925">925: </a>          <a href="../../../../../docs/manualpages/Tao/TaoAddLineSearchCounts.html">TaoAddLineSearchCounts</a>(tao);

<a name="line927">927: </a>          pcgd_fallback = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;
<a name="line928">928: </a>          <font color="#4169E1">if</font> (ls_status != TAOLINESEARCH_SUCCESS &amp;&amp; ls_status != TAOLINESEARCH_SUCCESS_USER) {
<a name="line929">929: </a>            <font color="#B22222">/* Going to perform a regular gradient descent step. */</font>
<a name="line930">930: </a>            ++cg-&gt;ls_fails;
<a name="line931">931: </a>            step = 0.0;
<a name="line932">932: </a>          }
<a name="line933">933: </a>        }
<a name="line934">934: </a>        <font color="#B22222">/* Fall back on the scaled gradient step */</font>
<a name="line935">935: </a>        <font color="#4169E1">if</font> (ls_status != TAOLINESEARCH_SUCCESS &amp;&amp; ls_status != TAOLINESEARCH_SUCCESS_USER) {
<a name="line936">936: </a>          ++cg-&gt;ls_fails;
<a name="line937">937: </a>          TaoBNCGResetUpdate(tao, gnorm2);
<a name="line938">938: </a>          TaoBNCGBoundStep(tao, cg-&gt;as_type, tao-&gt;stepdirection);
<a name="line939">939: </a>          <a href="../../../../../docs/manualpages/TaoLineSearch/TaoLineSearchSetInitialStepLength.html">TaoLineSearchSetInitialStepLength</a>(tao-&gt;linesearch, 1.0);
<a name="line940">940: </a>          <a href="../../../../../docs/manualpages/TaoLineSearch/TaoLineSearchApply.html">TaoLineSearchApply</a>(tao-&gt;linesearch, tao-&gt;solution, &amp;cg-&gt;f, cg-&gt;unprojected_gradient, tao-&gt;stepdirection, &amp;step, &amp;ls_status);
<a name="line941">941: </a>          <a href="../../../../../docs/manualpages/Tao/TaoAddLineSearchCounts.html">TaoAddLineSearchCounts</a>(tao);
<a name="line942">942: </a>        }

<a name="line944">944: </a>        <font color="#4169E1">if</font> (ls_status != TAOLINESEARCH_SUCCESS &amp;&amp; ls_status != TAOLINESEARCH_SUCCESS_USER) {
<a name="line945">945: </a>          <font color="#B22222">/* Nothing left to do but fail out of the optimization */</font>
<a name="line946">946: </a>          ++cg-&gt;ls_fails;
<a name="line947">947: </a>          step        = 0.0;
<a name="line948">948: </a>          tao-&gt;reason = <a href="../../../../../docs/manualpages/Tao/TaoConvergedReason.html">TAO_DIVERGED_LS_FAILURE</a>;
<a name="line949">949: </a>        } <font color="#4169E1">else</font> {
<a name="line950">950: </a>          <font color="#B22222">/* One of the fallbacks worked. Set them both back equal to false. */</font>
<a name="line951">951: </a>          pcgd_fallback = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html">PETSC_FALSE</a>;
<a name="line952">952: </a>        }
<a name="line953">953: </a>      }
<a name="line954">954: </a>    }
<a name="line955">955: </a>    <font color="#B22222">/* Convergence test for line search failure */</font>
<a name="line956">956: </a>    <font color="#4169E1">if</font> (tao-&gt;reason != <a href="../../../../../docs/manualpages/Tao/TaoConvergedReason.html">TAO_CONTINUE_ITERATING</a>) <font color="#4169E1">return</font> 0;

<a name="line958">958: </a>    <font color="#B22222">/* Standard convergence test */</font>
<a name="line959">959: </a>    <a href="../../../../../docs/manualpages/Tao/VecFischer.html">VecFischer</a>(tao-&gt;solution, cg-&gt;unprojected_gradient, tao-&gt;XL, tao-&gt;XU, cg-&gt;W);
<a name="line960">960: </a>    <a href="../../../../../docs/manualpages/Vec/VecNorm.html">VecNorm</a>(cg-&gt;W, <a href="../../../../../docs/manualpages/Vec/NORM_2.html">NORM_2</a>, &amp;resnorm);
<a name="line962">962: </a>    TaoLogConvergenceHistory(tao, cg-&gt;f, resnorm, 0.0, tao-&gt;ksp_its);
<a name="line963">963: </a>    <a href="../../../../../docs/manualpages/Tao/TaoMonitor.html">TaoMonitor</a>(tao, tao-&gt;niter, cg-&gt;f, resnorm, 0.0, step);
<a name="line964">964: </a>    <a href="../../../../../docs/manualpages/Sys/PetscUseTypeMethod.html">PetscUseTypeMethod</a>(tao, convergencetest, tao-&gt;cnvP);
<a name="line965">965: </a>    <font color="#4169E1">if</font> (tao-&gt;reason != <a href="../../../../../docs/manualpages/Tao/TaoConvergedReason.html">TAO_CONTINUE_ITERATING</a>) <font color="#4169E1">return</font> 0;
<a name="line966">966: </a>  }
<a name="line967">967: </a>  <font color="#B22222">/* Assert we have an updated step and we need at least one more iteration. */</font>
<a name="line968">968: </a>  <font color="#B22222">/* Calculate the next direction */</font>
<a name="line969">969: </a>  <font color="#B22222">/* Estimate the active set at the new solution */</font>
<a name="line970">970: </a>  TaoBNCGEstimateActiveSet(tao, cg-&gt;as_type);
<a name="line971">971: </a>  <font color="#B22222">/* Compute the projected gradient and its norm */</font>
<a name="line972">972: </a>  <a href="../../../../../docs/manualpages/Vec/VecCopy.html">VecCopy</a>(cg-&gt;unprojected_gradient, tao-&gt;gradient);
<a name="line973">973: </a>  <a href="../../../../../docs/manualpages/Vec/VecISSet.html">VecISSet</a>(tao-&gt;gradient, cg-&gt;active_idx, 0.0);
<a name="line974">974: </a>  <a href="../../../../../docs/manualpages/Vec/VecNorm.html">VecNorm</a>(tao-&gt;gradient, <a href="../../../../../docs/manualpages/Vec/NORM_2.html">NORM_2</a>, &amp;gnorm);
<a name="line975">975: </a>  gnorm2 = gnorm * gnorm;

<a name="line977">977: </a>  <font color="#B22222">/* Calculate some quantities used in the StepDirectionUpdate. */</font>
<a name="line978">978: </a>  <a href="../../../../../docs/manualpages/Vec/VecNorm.html">VecNorm</a>(tao-&gt;stepdirection, <a href="../../../../../docs/manualpages/Vec/NORM_2.html">NORM_2</a>, &amp;dnorm);
<a name="line979">979: </a>  <font color="#B22222">/* Update the step direction. */</font>
<a name="line980">980: </a>  TaoBNCGStepDirectionUpdate(tao, gnorm2, step, f_old, gnorm2_old, dnorm, pcgd_fallback);
<a name="line981">981: </a>  ++tao-&gt;niter;
<a name="line982">982: </a>  TaoBNCGBoundStep(tao, cg-&gt;as_type, tao-&gt;stepdirection);

<a name="line984">984: </a>  <font color="#4169E1">if</font> (cg-&gt;cg_type != CG_GradientDescent) {
<a name="line985">985: </a>    <font color="#B22222">/* Figure out which previously active variables became inactive this iteration */</font>
<a name="line986">986: </a>    <a href="../../../../../docs/manualpages/IS/ISDestroy.html">ISDestroy</a>(&amp;cg-&gt;new_inactives);
<a name="line987">987: </a>    <font color="#4169E1">if</font> (cg-&gt;inactive_idx &amp;&amp; cg-&gt;inactive_old) <a href="../../../../../docs/manualpages/IS/ISDifference.html">ISDifference</a>(cg-&gt;inactive_idx, cg-&gt;inactive_old, &amp;cg-&gt;new_inactives);
<a name="line988">988: </a>    <font color="#B22222">/* Selectively reset the CG step those freshly inactive variables */</font>
<a name="line989">989: </a>    <font color="#4169E1">if</font> (cg-&gt;new_inactives) {
<a name="line990">990: </a>      <a href="../../../../../docs/manualpages/Vec/VecGetSubVector.html">VecGetSubVector</a>(tao-&gt;stepdirection, cg-&gt;new_inactives, &amp;cg-&gt;inactive_step);
<a name="line991">991: </a>      <a href="../../../../../docs/manualpages/Vec/VecGetSubVector.html">VecGetSubVector</a>(cg-&gt;unprojected_gradient, cg-&gt;new_inactives, &amp;cg-&gt;inactive_grad);
<a name="line992">992: </a>      <a href="../../../../../docs/manualpages/Vec/VecCopy.html">VecCopy</a>(cg-&gt;inactive_grad, cg-&gt;inactive_step);
<a name="line993">993: </a>      <a href="../../../../../docs/manualpages/Vec/VecScale.html">VecScale</a>(cg-&gt;inactive_step, -1.0);
<a name="line994">994: </a>      <a href="../../../../../docs/manualpages/Vec/VecRestoreSubVector.html">VecRestoreSubVector</a>(tao-&gt;stepdirection, cg-&gt;new_inactives, &amp;cg-&gt;inactive_step);
<a name="line995">995: </a>      <a href="../../../../../docs/manualpages/Vec/VecRestoreSubVector.html">VecRestoreSubVector</a>(cg-&gt;unprojected_gradient, cg-&gt;new_inactives, &amp;cg-&gt;inactive_grad);
<a name="line996">996: </a>    }
<a name="line997">997: </a>    <font color="#B22222">/* Verify that this is a descent direction */</font>
<a name="line998">998: </a>    <a href="../../../../../docs/manualpages/Vec/VecDot.html">VecDot</a>(tao-&gt;gradient, tao-&gt;stepdirection, &amp;gd);
<a name="line999">999: </a>    <a href="../../../../../docs/manualpages/Vec/VecNorm.html">VecNorm</a>(tao-&gt;stepdirection, <a href="../../../../../docs/manualpages/Vec/NORM_2.html">NORM_2</a>, &amp;dnorm);
<a name="line1000">1000: </a>    <font color="#4169E1">if</font> (PetscIsInfOrNanReal(gd) || (gd / (dnorm * dnorm) &lt;= -1e10 || gd / (dnorm * dnorm) &gt;= -1e-10)) {
<a name="line1001">1001: </a>      <font color="#B22222">/* Not a descent direction, so we reset back to projected gradient descent */</font>
<a name="line1002">1002: </a>      TaoBNCGResetUpdate(tao, gnorm2);
<a name="line1003">1003: </a>      TaoBNCGBoundStep(tao, cg-&gt;as_type, tao-&gt;stepdirection);
<a name="line1004">1004: </a>      ++cg-&gt;descent_error;
<a name="line1005">1005: </a>    } <font color="#4169E1">else</font> {
<a name="line1006">1006: </a>    }
<a name="line1007">1007: </a>  }
<a name="line1008">1008: </a>  <font color="#4169E1">return</font> 0;
<a name="line1009">1009: </a>}

<a name="line1011">1011: </a><strong><font color="#4169E1"><a name="TaoBNCGSetH0"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> TaoBNCGSetH0(<a href="../../../../../docs/manualpages/Tao/Tao.html">Tao</a> tao, <a href="../../../../../docs/manualpages/Mat/Mat.html">Mat</a> H0)</font></strong>
<a name="line1012">1012: </a>{
<a name="line1013">1013: </a>  TAO_BNCG *cg = (TAO_BNCG *)tao-&gt;data;

<a name="line1015">1015: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectReference.html">PetscObjectReference</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html">PetscObject</a>)H0);
<a name="line1016">1016: </a>  cg-&gt;pc = H0;
<a name="line1017">1017: </a>  <font color="#4169E1">return</font> 0;
<a name="line1018">1018: </a>}
</pre>
</body>

</html>
